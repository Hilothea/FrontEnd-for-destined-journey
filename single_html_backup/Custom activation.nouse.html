<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>异世界转生手续办理处</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+SC:wght@400;500&display=swap');

    :root {
      --bg-color: #f5efe6;
      --text-color: #4a3b31;
      --border-color-light: #d3c5b3;
      --border-color-strong: #785a4e;
      --title-color: #5d4037;
      --input-bg-color: rgba(253, 250, 245, 0.9);
      --button-bg-color: #d7c8b6;
      --font-title: 'Cinzel', serif;
      --font-body: 'Noto Serif SC', serif;
      --placeholder-color: #9e8a7e;
      --points-color: #b22222;
    }

    body {
      font-family: var(--font-body);
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAMAAAAp4XiGAAAAA3RFWHRDcmVhdGlvbiBUaW1lADE2NTEyNjIxMjEyMWtYJ+B0AAAAclBMVEVsbGz////v7+/MzMzj4+Pp6enh4eH8/Pz5+fnv7+/w8PDi4uLt7e3m5ub09PTx8fHk5OTZ2dnJycmrq6vT09Pm5ubU1NS/v7/x8fHe3t7c3Nzc3Nzs7OzLy8vo6OjIyMiampoVFRXCwsI4ODgjIyP9/f3///+m9s3nAAAAEHRSTlMAAQIDBAVGh4uNjpCVmJ+goaqssba5v8DBw8XLzP3+uK6o8AAAAXFJREFUSMftlWd3gjAQhp0ZJCiCEFzOaXv9PyiE9pS90Ie3d1p1n7nQ0/kF43wY0Q/2MDCzFh4YAEUOFoDEe4EATD1QgG0C+gB1gC9QAAKGDWjT0qT2pFuE3XnrSa9Tq+0B2H9r2m0T7Q0AAMCpUQT+wufNmJgAgGr+C5+D11rK/AHAQhR2BgcAAICBEAxNs2v2FQC4131sHxIBBggD14VpAwAAwPYGg4jWn+4CgGpyc0cAwD4A/l0bAQCEiM+e/a2pAK4MwPAHCxogwPcgYGAAlzZgH5L9aHroqOnHkQM+ku38x/cWl482A/zJ3y0GAOg++k9V/71V2gAAq0V/fImbAAAAAElFTnoGM2vAAAAAElFTkSuQmCC');
      background-repeat: repeat;
    }

    .creator-scroll {
      border: 2px solid var(--border-color-strong);
      border-radius: 0;
      padding: 25px 30px;
      background-color: rgba(240, 230, 210, 0.9);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      max-width: 550px;
      width: 95%;
      margin: auto;
      max-height: 90vh;
      overflow-y: auto;
    }

    .creator-scroll::-webkit-scrollbar {
      width: 0;
    }

    .creator-scroll {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .main-title {
      font-family: var(--font-title);
      font-weight: 700;
      color: var(--title-color);
      text-align: center;
      font-size: 1.8em;
      letter-spacing: 2px;
      margin: 0 0 25px 0;
    }

    .reincarnation-points {
      font-family: var(--font-title);
      font-weight: 700;
      color: var(--points-color);
      font-size: 1em;
      padding: 8px;
      background-color: var(--button-bg-color);
      border: 1px solid var(--border-color-strong);
      border-radius: 0;
      text-align: center;
      margin: 0;
      width: 100%;
      box-sizing: border-box;
    }

    .reincarnation-points-inline {
      font-size: 0.9em;
      font-weight: 500;
      color: var(--text-color);
    }

    .input-group {
      margin-bottom: 18px;
    }

    label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--title-color);
      font-size: 1.05em;
    }

    input[type='text'],
    input[type='number'],
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-color-light);
      border-radius: 0;
      background-color: var(--input-bg-color);
      color: var(--text-color);
      font-family: var(--font-body);
      font-size: 1em;
      box-sizing: border-box;
      transition: border-color 0.2s, box-shadow 0.2s;
      resize: vertical;
    }

    input[type='range'] {
      -webkit-appearance: none;
      appearance: none;
      width: calc(100% - 70px);
      height: 8px;
      background: var(--border-color-light);
      border-radius: 0;
      outline: none;
      cursor: pointer;
      vertical-align: middle;
      margin-right: 10px;
      display: inline-block;
    }

    input[type='range']::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 0;
      background: var(--title-color);
      cursor: pointer;
      border: 2px solid var(--border-color-strong);
      transition: background 0.15s ease-in-out;
    }

    input[type='range']::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 0;
      background: var(--title-color);
      cursor: pointer;
      border: 2px solid var(--border-color-strong);
      transition: background 0.15s ease-in-out;
    }

    .level-control,
    .destiny-points-control {
      display: flex;
      align-items: center;
    }

    .level-control input[type='number'],
    .destiny-points-control input[type='number'] {
      width: 60px;
      text-align: center;
      padding: 5px 8px;
    }

    .attributes-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    .attribute-control {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: var(--input-bg-color);
      padding: 5px 10px;
      border: 1px solid var(--border-color-light);
    }

    .attribute-control .stat-name {
      font-weight: 500;
      flex-basis: 25%;
    }

    .attribute-control .stat-value {
      font-weight: bold;
      color: var(--title-color);
      flex-basis: 15%;
      text-align: center;
    }

    .attribute-control .ap-buttons {
      display: flex;
      align-items: center;
      flex-basis: 40%;
      justify-content: center;
    }

    .attribute-control .ap-btn {
      background-color: var(--button-bg-color);
      border: 1px solid var(--border-color-strong);
      color: var(--text-color);
      font-weight: bold;
      cursor: pointer;
      width: 25px;
      height: 25px;
      line-height: 22px;
      text-align: center;
      transition: background-color 0.2s;
    }

    .attribute-control .ap-btn:hover {
      background-color: #c6b8a5;
    }

    .attribute-control .ap-btn:disabled {
      background-color: #e0e0e0;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .attribute-control .ap-input {
      width: 50px;
      text-align: center;
      border: none;
      background: transparent;
      margin: 0 5px;
      font-weight: 500;
      color: var(--points-color);
      -moz-appearance: textfield;
      appearance: textfield;
    }

    .attribute-control .ap-input::-webkit-outer-spin-button,
    .attribute-control .ap-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    ::placeholder {
      color: var(--placeholder-color);
      opacity: 1;
    }

    select:has(option[value='']:checked) {
      color: var(--placeholder-color);
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--border-color-strong);
      box-shadow: 0 0 5px rgba(120, 90, 78, 0.4);
    }

    .custom-input {
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease, margin-top 0.3s ease;
      margin-top: -10px;
    }

    .custom-input.show {
      display: block;
      opacity: 1;
      margin-top: 10px;
    }

    .conditional-display-group {
      display: none;
      opacity: 0;
      max-height: 0;
      overflow: hidden;
      margin-bottom: 0 !important;
      transition: opacity 0.4s ease, max-height 0.4s ease, margin-bottom 0.4s ease;
    }

    .conditional-display-group.show {
      display: block;
      opacity: 1;
      max-height: 250px;
      margin-bottom: 18px !important;
    }

    .skill-option {
      display: flex;
      align-items: flex-start;
      cursor: pointer;
      user-select: none;
      padding: 8px 10px;
      border: 1px solid var(--border-color-light);
      border-radius: 0;
      transition: background-color 0.2s, border-color 0.2s;
      flex-basis: 100%;
      box-sizing: border-box;
      background-color: var(--input-bg-color);
    }

    .skill-option:hover {
      background-color: rgba(220, 210, 190, 0.6);
      border-color: var(--border-color-strong);
    }

    .skill-option-content {
      display: flex;
      flex-direction: column;
      flex-grow: 1;
    }

    .skill-main-info {
      font-weight: 500;
      color: var(--title-color);
      font-size: 0.95em;
    }

    .skill-option .skill-description {
      opacity: 1;
      margin-top: 6px;
      font-size: 0.85em;
      color: var(--text-color);
      line-height: 1.3;
    }

    .skill-option input[type='checkbox'],
    .skill-option input[type='radio'] {
      margin-right: 8px;
      appearance: none;
      width: 16px;
      height: 16px;
      border: 1px solid var(--border-color-strong);
      border-radius: 0;
      background-color: #fff;
      position: relative;
      cursor: pointer;
      flex-shrink: 0;
    }

    .skill-option input[type='checkbox']:checked,
    .skill-option input[type='radio']:checked {
      background-color: var(--title-color);
      border-color: var(--title-color);
    }

    .skill-option input[type='checkbox']:checked::after,
    .skill-option input[type='radio']:checked::after {
      content: '✔';
      color: #fff;
      font-size: 11px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .skill-option input[type='checkbox']:checked,
    .skill-option input[type='radio']:checked {
      box-shadow: 0 0 5px rgba(120, 90, 78, 0.4);
    }

    .random-button {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      font-family: var(--font-body);
      font-weight: 500;
      font-size: 1em;
      color: var(--title-color);
      background-color: var(--button-bg-color);
      border: 1px solid var(--border-color-strong);
      border-radius: 0;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s ease;
    }

    .random-button:hover {
      background-color: #c6b8a5;
    }

    .selection-control {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .selection-btn {
      padding: 10px 12px;
      font-family: var(--font-body);
      font-weight: 500;
      font-size: 1em;
      color: var(--title-color);
      background-color: var(--input-bg-color);
      border: 1px solid var(--border-color-light);
      border-radius: 0;
      cursor: pointer;
      text-align: left;
      transition: all 0.2s ease;
    }

    .selection-btn:hover {
      border-color: var(--border-color-strong);
      background-color: #e8e0d5;
    }

    .selection-summary {
      font-size: 0.85em;
      color: var(--text-color);
      padding-left: 5px;
    }

    .submit-button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      font-family: var(--font-title);
      font-weight: 700;
      font-size: 1.2em;
      color: var(--title-color);
      background-color: var(--button-bg-color);
      border: 1px solid var(--border-color-strong);
      border-radius: 0;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s ease;
    }

    .submit-button:hover {
      background-color: #c6b8a5;
      transform: translateY(-2px);
    }

    .rarity-common {
      color: #6c757d;
    }

    .rarity-uncommon {
      color: #4caf50;
    }

    .rarity-rare {
      color: #2196f3;
    }

    .rarity-epic {
      color: #9c27b0;
    }

    .rarity-legendary {
      color: #ffc107;
    }

    .rarity-mythic {
      color: #f44336;
    }

    .skill-main-info .rarity-common,
    .skill-main-info .rarity-uncommon,
    .skill-main-info .rarity-rare,
    .skill-main-info .rarity-epic,
    .skill-main-info .rarity-legendary,
    .skill-main-info .rarity-mythic {
      font-weight: bold;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.6);
      animation: fadeIn 0.3s;
    }

    .modal-content {
      background-color: var(--bg-color);
      margin: 5% auto;
      padding: 25px;
      border: 2px solid var(--border-color-strong);
      width: 90%;
      max-width: 600px;
      position: relative;
      animation: slideIn 0.3s;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-family: var(--font-title);
      font-size: 1.5em;
      color: var(--title-color);
      margin: 0;
    }

    .close-btn {
      color: var(--text-color);
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close-btn:hover,
    .close-btn:focus {
      color: var(--points-color);
      text-decoration: none;
    }

    .modal-tabs-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 3px solid var(--border-color-light);
    }

    .modal-tab {
      padding: 6px 12px;
      font-family: var(--font-body);
      font-weight: 500;
      font-size: 0.95em;
      color: var(--text-color);
      background-color: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .modal-tab:hover {
      color: var(--title-color);
    }

    .modal-tab.active {
      color: var(--title-color);
      border-bottom-color: var(--border-color-strong);
      font-weight: 700;
    }
    .accordion-group {
      border-bottom: 2px solid var(--border-color-light);
    }
    .accordion-group:last-child {
      border-bottom: none;
    }

    .accordion-header {

      width: 100%;
      padding: 2px 10px;
      font-family: var(--font-body);
      font-weight: 700;
      font-size: 1.05em;
      color: var(--title-color);
      background-color: transparent;
      border: none;
      text-align: left;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.2s;
      border-bottom: 2px solid var(--border-color-light);
    }

    .accordion-header:hover {
      background-color: rgba(220, 210, 190, 0.4);
    }

    .modal-options-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 65vh;
      padding-right: 10px;
      overflow-y: auto;
    }

    .modal-footer {
      margin-top: 20px;
      text-align: right;
    }

    .modal-confirm-btn {
      padding: 10px 20px;
      font-family: var(--font-body);
      font-weight: 700;
      font-size: 1em;
      color: var(--title-color);
      background-color: var(--button-bg-color);
      border: 1px solid var(--border-color-strong);
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .modal-confirm-btn:hover {
      background-color: #c6b8a5;
    }

    .accordion-header::after {
      content: '+';
      font-size: 1.2em;
      font-weight: bold;
      color: var(--text-color);
      transition: transform 0.3s ease;
    }

    .accordion-group.active .accordion-header::after {
      content: '−';
      transform: rotate(180deg);
    }

    .accordion-content {
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transition: max-height 0.4s ease-out, opacity 0.3s ease-in, padding 0.3s ease-out;
      padding: 0 10px;
    }

    .accordion-group.active .accordion-content {
      max-height: 45vh;
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
      opacity: 1;
      padding: 5px 10px 15px 10px;
      transition: max-height 0.5s ease-in, opacity 0.4s ease-out, padding 0.4s ease-in;
    }
    .review-category-header {
        font-family: var(--font-title);
        font-size: 1.2em;
        color: var(--title-color);
        margin-top: 15px;
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 1px solid var(--border-color-strong);
    }
    .review-category-header:first-child {
        margin-top: 0;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slideIn {
      from {
        transform: translateY(-30px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }


    @media (max-width: 600px) {
      body {
        padding: 10px;
      }

      .creator-scroll {
        padding: 20px;
      }

      .main-title {
        font-size: 1.5em;
      }

      label {
        font-size: 1em;
      }

      .attributes-container {
        grid-template-columns: 1fr;
      }

      .modal-content {
        width: 85%;
        margin: 10% auto;
      }
    }
  </style>
</head>

<body>
  <div class="creator-scroll">
    <div class="main-title">命定之诗与黄昏之歌</div>

    <button id="randomizeAllButton" class="random-button">一键随机生成</button>
    <button id="resetButton" class="random-button"
      style="margin-top: 10px; margin-bottom: 20px; background-color: #e8e0d5;">重置所有选项</button>

    <div class="reincarnation-points" style="margin-bottom: 15px;">可用转生点: <span
        id="reincarnationPointsDisplay">300</span></div>
    <button id="randomizePointsButton" class="random-button" style="margin-bottom: 15px; width: 100%;">随机初始点数</button>

    <div class="input-group"><label for="nameInput">🖋️ 姓名</label><input type="text" id="nameInput"
        placeholder="别告诉我你叫“龙傲天”" /></div>
    <div class="input-group"><label for="genderInput">🌗 性别</label><select id="genderInput">
        <option value="" disabled selected>莉莉丝要知道怎么称呼你</option>
        <option value="男">男</option>
        <option value="女">女</option>
        <option value="雄性">雄性</option>
        <option value="雌性">雌性</option>
        <option value="custom">自定义</option>
      </select><input type="text" id="customGenderInput" class="custom-input" placeholder="想尝试点刺激的？" /></div>
    <div class="input-group"><label for="ageInput">⏳ 年龄</label><input type="number" id="ageInput"
        placeholder="好决定给你什么剧本" min="0" /></div>

    <div class="input-group">
      <label for="raceInput">🩸 种族 <span class="reincarnation-points-inline">剩余: <span
            class="reincarnation-points-value">300</span>点</span></label>
      <select id="raceInput">
        <option value="" disabled selected>确定不是隔壁村伪装的地精？</option>
        <option value="人类">人类</option>
        <option value="兽族">兽族</option>
        <option value="精灵">精灵 (-10点)</option>
        <option value="翼民">翼民 (-10点)</option>
        <option value="自然魔物(括号内自行编辑具体魔物/详见世界书)">自然魔物(括号内自行编辑具体魔物/详见世界书) (-10点)</option>
        <option value="亡灵种族(括号内自行编辑具体种类/详见世界书)">亡灵种族(括号内自行编辑具体种类/详见世界书) (-10点)</option>
        <option value="深渊魔族(括号内自行编辑具体种类/详见世界书)">深渊魔族(括号内自行编辑具体种类/详见世界书) (-20点)</option>
        <option value="custom">自定义 (-80点)</option>
      </select>
      <input type="text" id="customRaceInput" class="custom-input" placeholder="放心，你不是史莱姆就是自带金手指的废柴勇者，总之肯定有专属作弊器！" />
    </div>
    <div class="input-group">
      <label for="identityInput">👑 世间的起点 <span class="reincarnation-points-inline">剩余: <span
            class="reincarnation-points-value">300</span>点</span></label>
      <select id="identityInput">
        <option value="" disabled selected>开局一条狗？还是一个国？</option>
        <option value="沦为奴隶">沦为奴隶 (+20点)</option>
        <option value="自由平民">自由平民 (-0点)</option>
        <option value="中产阶级">中产阶级 (-20点)</option>
        <option value="贵族阶级">贵族阶级 (-40点)</option>
        <option value="游荡亡灵">游荡亡灵 (-0点)</option>
        <option value="野生魔物(魔兽)">野生魔物(魔兽) (-0点)</option>
        <option value="魔王残党">魔王残党 (+20点)</option>
        <option value="custom">自定义 (-80点)</option>
      </select>
      <input type="text" id="customIdentityInput" class="custom-input" placeholder="'父母'一栏写着'系统赠送'。" />
    </div>
    <div class="input-group">
      <label for="startLocationInput">🗺️ 起始地点 <span class="reincarnation-points-inline">剩余: <span
            class="reincarnation-points-value">300</span>点</span></label>
      <select id="startLocationInput">
        <option value="" disabled selected>新手村选得好，神装掉到老</option>
        <option value="大陆中东部区域-奥古斯提姆帝国">大陆中东部区域-奥古斯提姆帝国</option>
        <option value="大陆东南部区域-索伦蒂斯王国">大陆东南部区域-索伦蒂斯王国</option>
        <option value="大陆东北部区域-诺斯加德联盟">大陆东北部区域-诺斯加德联盟</option>
        <option value="大陆中西部区域-无尽风痕草原-卡拉什特里斯(兽族联盟)">大陆中西部区域-无尽风痕草原-卡拉什特里斯(兽族联盟)</option>
        <option value="大陆西南部区域-无尽树海-奥古斯提姆帝国-诺瓦·瓦伦蒂亚城">大陆西南部区域-无尽树海-奥古斯提姆帝国-诺瓦·瓦伦蒂亚城</option>
        <option value="大陆中央区域-神迹山脉-天空圣域高原-圣都梵尼亚">大陆中央区域-神迹山脉-天空圣域高原-圣都梵尼亚</option>
        <option value="大陆西南端-翡翠之心-艾尔文海姆(精灵王国)">大陆西南端-翡翠之心-艾尔文海姆(精灵王国)</option>
        <option value="大陆东北部沿海区域-伯伦斯法环联邦-雾晶港">大陆东北部沿海区域-伯伦斯法环联邦-雾晶港</option>
        <option value="大陆西南部区域-无尽树海-雨林中层区域">大陆西南部区域-无尽树海-雨林中层区域</option>
        <option value="大陆西南部区域-诺瓦尔河流域-主河道中游河底">大陆西南部区域-诺瓦尔河流域-主河道中游河底</option>
        <option value="大陆上空-泣歌云海-艾琉德雷姆·尼尔(泣空遗迹)">大陆上空-泣歌云海-艾琉德雷姆·尼尔(泣空遗迹)</option>
        <option value="大陆南端-悲鸣沼泽-伯恩·瑞瑟喃斯(骸响之都)-城门内">大陆南端-悲鸣沼泽-伯恩·瑞瑟喃斯(骸响之都)-城门内</option>
        <option value="大陆西南部区域-无尽树海-雨林中央-无尽深渊地城-地下23层">大陆西南部区域-无尽树海-雨林中央-无尽深渊地城-地下23层</option>
        <option value="无尽海东部-碎星群岛-蓝泪岛">无尽海东部-碎星群岛-蓝泪岛</option>
        <option value="custom">自定义</option>
      </select>
      <input type="text" id="customStartLocationInput" class="custom-input" placeholder="恭喜，被空投到魔王后院的菜地。" />
    </div>

    <div class="input-group" id="level-group" style="display: none;">
      <label for="levelInput">✨ 初始等级 <span class="reincarnation-points-inline">剩余: <span
            class="reincarnation-points-value">300</span>点</span></label>
      <div class="level-control"><input type="range" id="levelInputSlider" min="1" max="20" value="1" /><input
          type="number" id="levelInputNumber" min="1" max="20" value="1" /></div>
      <small>(当前等级消耗: <span id="levelCostDisplay">0</span> 点)</small>
    </div>
    <div class="input-group" id="attributes-group">
      <label>
        <div>🎲 初始属性 <small style="display: block; font-weight: normal; margin-top: 4px;">(剩余AP: <span
              id="apDisplay">5</span>)</small></div>
      </label>
      <button id="randomizeAttributesButton" class="random-button" style="margin-bottom: 10px;">随机分配AP</button>
      <div class="attributes-container"></div>
    </div>

    <div class="input-group">
      <label>⚔️ 初始装备 <span class="reincarnation-points-inline">剩余: <span
            class="reincarnation-points-value">300</span>点</span></label>
      <div class="selection-control"><button class="selection-btn" data-category="equipments">选择初始装备</button>
        <div class="selection-summary" id="equipmentsSummary">已选0件，消耗0点</div>
      </div>
    </div>
    <div class="input-group">
      <label>🎒 初始物品 <span class="reincarnation-points-inline">剩余: <span
            class="reincarnation-points-value">300</span>点</span></label>
      <div class="selection-control"><button class="selection-btn" data-category="items">选择初始物品</button>
        <div class="selection-summary" id="itemsSummary">已选0件，消耗0点</div>
      </div>
    </div>
    <div class="input-group">
      <label>💫 技能选择 <span class="reincarnation-points-inline">剩余: <span
            class="reincarnation-points-value">300</span>点</span></label>
      <div class="selection-control"><button class="selection-btn" data-category="skills">选择技能</button>
        <div class="selection-summary" id="skillsSummary">已选0件，消耗0点</div>
      </div>
    </div>
    <div class="input-group">
      <label>❤️ 初始红线对象 <span class="reincarnation-points-inline">剩余: <span
            class="reincarnation-points-value">300</span>点</span></label>
      <div class="selection-control"><button class="selection-btn" data-category="redThreads">选择初始红线对象(限定一个)</button>
        <div class="selection-summary" id="redThreadsSummary">已选0件，消耗0点</div>
      </div>
    </div>
    <div class="input-group">
      <label>🧭 初始背景</label>
      <div class="selection-control"><button class="selection-btn" data-category="backgrounds">选择初始背景...</button>
        <div class="selection-summary" id="backgroundsSummary">未选择</div>
      </div>
    </div>

    <div id="backgroundStoryGroup" class="input-group conditional-display-group">
      <label>📜 你的初始背景故事</label>
      <textarea id="backgroundStory" rows="4" placeholder="你选择了自定义开局，请在此处填写你的背景故事，这将作为游戏开局的引入..."></textarea>
    </div>
    <div class="input-group">
        <label for="reviewButton">📜 档案总览</label>
        <button id="reviewButton" class="selection-btn" style="text-align: center;">查看已选档案</button>
    </div>
    <div class="input-group">
      <label for="destinyPointsInput">💖 命运点数 <span class="reincarnation-points-inline">剩余: <span
            class="reincarnation-points-value">300</span>点</span></label>
      <div class="destiny-points-control">
        <input type="range" id="destinyPointsInputSlider" min="0" value="0" step="1" />
        <input type="number" id="destinyPointsInputNumber" min="0" value="0" step="1" />
      </div>
      <small>(1转生点 = 10命运点数)</small>
    </div>

    <button id="sendButton" class="submit-button">踏上旅程</button>
  </div>

  <div id="selectionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle" class="modal-title">选择</h2>
        <span class="close-btn">&times;</span>
      </div>
      <div id="modalTabsContainer" class="modal-tabs-container">
      </div>
      <div id="modalOptionsList" class="modal-options-list">
      </div>
      <div class="modal-footer">
        <button id="modalConfirmBtn" class="modal-confirm-btn">确认选择</button>
      </div>
    </div>
  </div>
  <div id="reviewModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="reviewModalTitle" class="modal-title">已选档案总览</h2>
        <span id="reviewCloseBtn" class="close-btn">&times;</span>
      </div>
      <div id="reviewModalOptionsList" class="modal-options-list">
      </div>
      <div class="modal-footer">
        <button id="reviewModalConfirmBtn" class="modal-confirm-btn">确认更改</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const INITIAL_REINCARNATION_POINTS = 300;
      let currentReincarnationPoints = INITIAL_REINCARNATION_POINTS;
      let baseReincarnationPoints = INITIAL_REINCARNATION_POINTS;
      let isInitialLoad = true;

      const RARITY_MAP = {
        only: '唯一', common: '普通', uncommon: '优良', rare: '稀有', epic: '史诗', legendary: '传说', mythic: '神话',
        common_spell: '普通-法术', common_other: '普通-其他', common_prayer: '普通-祷告', common_combat_skill: '普通-战技', common_ritual: '普通-仪式',
      };
      const BACKGROUND_TYPE_MAP = {
        general: '通用背景',
        race: '种族限定',
        location: '地区限定',
      };
      const RARITY_PRIORITY = { common: 0, uncommon: 1, rare: 2, epic: 3, legendary: 4, mythic: 5 };

      const ALL_POSSIBLE_EQUIPMENTS = [];

      const ALL_POSSIBLE_ITEMS = [];

      const ALL_POSSIBLE_SKILLS = [];

      const ALL_POSSIBLE_RED_THREADS = [];

      const ALL_POSSIBLE_BACKGROUNDS = [];

      const ALL_POSSIBLE_TALISMANS = []

      const MODAL_TABS_CONFIG = {
        equipments: [
          { name: '基础装备', data: ALL_POSSIBLE_EQUIPMENTS, isDefault: true },
          { name: '法环护符拓展', data: ALL_POSSIBLE_TALISMANS }
        ],
        items: [
          { name: '基础物资', data: ALL_POSSIBLE_ITEMS, isDefault: true },
        ],
        skills: [
          { name: '基础技能', data: ALL_POSSIBLE_SKILLS, isDefault: true },
        ],
        redThreads: [
          { name: '基础红线对象', data: ALL_POSSIBLE_RED_THREADS, isDefault: true },
        ],
        backgrounds: [
          { name: '基础背景', data: ALL_POSSIBLE_BACKGROUNDS, isDefault: true },
        ],
      }

      const COSTS = {
        race: { '精灵': 10, '翼民': 10, '自然魔物(括号内自行编辑具体魔物/详见世界书)': 10, '亡灵种族(括号内自行编辑具体种类/详见世界书)': 10, '深渊魔族(括号内自行编辑具体种类/详见世界书)': 20, 'custom': 80 },
        identity: { '沦为奴隶': -20, '自由平民': 0, '中产阶级': 20, '贵族阶级': 40, '游荡亡灵': 0, '野生魔物(魔兽)': 0, '魔王残党': -20, 'custom': 80 },
        startLocation: {},
      };

      const ALL_DATA_SOURCES = {
          equipments: [...ALL_POSSIBLE_EQUIPMENTS, ...ALL_POSSIBLE_TALISMANS],
          items: ALL_POSSIBLE_ITEMS,
          skills: ALL_POSSIBLE_SKILLS,
          redThreads: ALL_POSSIBLE_RED_THREADS,
          backgrounds: ALL_POSSIBLE_BACKGROUNDS
      };

      const elements = {
        reincarnationPointsDisplay: document.getElementById('reincarnationPointsDisplay'),
        raceInput: document.getElementById('raceInput'), customRaceInput: document.getElementById('customRaceInput'),
        identityInput: document.getElementById('identityInput'), customIdentityInput: document.getElementById('customIdentityInput'),
        startLocationInput: document.getElementById('startLocationInput'), customStartLocationInput: document.getElementById('customStartLocationInput'),
        levelInputSlider: document.getElementById('levelInputSlider'), levelInputNumber: document.getElementById('levelInputNumber'),
        levelCostDisplay: document.getElementById('levelCostDisplay'),
        destinyPointsInputSlider: document.getElementById('destinyPointsInputSlider'), destinyPointsInputNumber: document.getElementById('destinyPointsInputNumber'),
        nameInput: document.getElementById('nameInput'), genderInput: document.getElementById('genderInput'),
        customGenderInput: document.getElementById('customGenderInput'), ageInput: document.getElementById('ageInput'),
        backgroundStory: document.getElementById('backgroundStory'),
        backgroundStoryGroup: document.getElementById('backgroundStoryGroup'),
        sendButton: document.getElementById('sendButton'), randomizeAllButton: document.getElementById('randomizeAllButton'),
        resetButton: document.getElementById('resetButton'), randomizePointsButton: document.getElementById('randomizePointsButton'),
        attributesContainer: document.querySelector('.attributes-container'), apDisplay: document.getElementById('apDisplay'),
        randomizeAttributesButton: document.getElementById('randomizeAttributesButton'),
        modal: document.getElementById('selectionModal'), modalTitle: document.getElementById('modalTitle'),
        modalOptionsList: document.getElementById('modalOptionsList'), modalConfirmBtn: document.getElementById('modalConfirmBtn'),
        modalTabsContainer: document.getElementById('modalTabsContainer'),
        closeBtn: document.querySelector('.close-btn'),
        equipmentsSummary: document.getElementById('equipmentsSummary'),
        itemsSummary: document.getElementById('itemsSummary'),
        skillsSummary: document.getElementById('skillsSummary'),
        redThreadsSummary: document.getElementById('redThreadsSummary'),
        backgroundsSummary: document.getElementById('backgroundsSummary'),
        reviewButton: document.getElementById('reviewButton'),
        reviewModal: document.getElementById('reviewModal'),
        reviewModalTitle: document.getElementById('reviewModalTitle'),
        reviewModalOptionsList: document.getElementById('reviewModalOptionsList'),
        reviewModalConfirmBtn: document.getElementById('reviewModalConfirmBtn'),
        reviewCloseBtn: document.getElementById('reviewCloseBtn'),
      };

      const attributes = ['力量', '敏捷', '体质', '智力', '精神'];
      let attributePoints = {};
      let selections = {
        equipments: [],
        items: [],
        skills: [],
        redThreads: [],
        backgrounds: null,
      };
      let currentOpenCategory = null;

      function updateBackgroundStoryVisibility() {
        const show = selections.backgrounds === '【自定义开局】';
        elements.backgroundStoryGroup.classList.toggle('show', show);
      }

      function openModal(category) {
        currentOpenCategory = category;
        elements.modal.style.display = 'block';
        populateModal(category);
      }

      function closeModal() {
        elements.modal.style.display = 'none';
        elements.modalOptionsList.innerHTML = '';
        currentOpenCategory = null;
      }

      function populateModal(category) {
        if (!category) { return; }
        let title, isRadio = false;
        let mainData;
        switch (category) {
          case 'equipments': title = '选择初始装备'; break;
          case 'items': mainData = ALL_POSSIBLE_ITEMS; title = '选择初始物品'; break;
          case 'skills': mainData = ALL_POSSIBLE_SKILLS; title = '选择初始技能'; break;
          case 'redThreads': mainData = ALL_POSSIBLE_RED_THREADS; title = '选择初始红线对象'; isRadio = true; break;
          case 'backgrounds': mainData = ALL_POSSIBLE_BACKGROUNDS; title = '选择初始背景'; isRadio = true; break;
        }
        elements.modalTitle.textContent = title;
        elements.modalTabsContainer.innerHTML = '';
        elements.modalOptionsList.innerHTML = '';
        const tabsConfig = MODAL_TABS_CONFIG[category];
        if (tabsConfig) {
          let defaultTabIndex = tabsConfig.findIndex(tab => tab.isDefault) || 0;
          tabsConfig.forEach((tabConfig, index) => {
            const tabElement = document.createElement('button');
            tabElement.className = 'modal-tab';
            tabElement.textContent = tabConfig.name;
            tabElement.dataset.tabIndex = index;
            tabElement.addEventListener('click', () => {
              elements.modalTabsContainer.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
              tabElement.classList.add('active');
              populateTabContent(tabConfig.data, category, isRadio);
            });
            elements.modalTabsContainer.appendChild(tabElement);
          });
          elements.modalTabsContainer.querySelector(`[data-tab-index="${defaultTabIndex}"]`).click();
        } else {
          populateTabContent(mainData, category, isRadio);
        }
        if (category === 'backgrounds') {
          updateBackgroundAvailabilityInModal();
        }
      }

      function populateTabContent(data, category, isRadio) {
        elements.modalOptionsList.innerHTML = '';
        if (!data) return;
        const currentSelections = selections[category] || [];
        let groupByKey, groupKeyMap, groupOrder;

        if (category === 'backgrounds') {
            groupByKey = 'bgType';
            groupKeyMap = BACKGROUND_TYPE_MAP;
            groupOrder = ['通用背景', '种族限定', '地区限定'];
        } else if (category === 'redThreads') {
            groupByKey = 'type';
            groupKeyMap = null;
            groupOrder = ['第一层级', '第二层级', '第三层级'];
        } else {
            groupByKey = 'rarity';
            groupKeyMap = RARITY_MAP;
            groupOrder = ['唯一', '普通', '优良', '稀有', '史诗', '传说', '神话', '普通-战技', '普通-法术', '普通-祷告', '普通-仪式', '普通-其他'];
        }
        const groupedData = data.reduce((acc, item) => {
          const key = item[groupByKey];
          const groupName = groupKeyMap ? (groupKeyMap[key] || '其他') : (key || '其他');
          if (!acc[groupName]) {
            acc[groupName] = [];
          }
          acc[groupName].push(item);
          return acc;
        }, {});
        const sortedGroupKeys = Object.keys(groupedData).sort((a, b) => {
          const indexA = groupOrder.indexOf(a);
          const indexB = groupOrder.indexOf(b);
          if (indexA === -1) return 1;
          if (indexB === -1) return -1;
          return indexA - indexB;
        });
        sortedGroupKeys.forEach(groupName => {
          if (groupedData[groupName].length === 0) return;
          const groupContainer = document.createElement('div');
          groupContainer.className = 'accordion-group';
          const header = document.createElement('button');
          header.className = 'accordion-header';
          header.textContent = `${groupName} (${groupedData[groupName].length})`;
          const content = document.createElement('div');
          content.className = 'accordion-content';

          groupedData[groupName].forEach(item => {
            const isChecked = currentSelections.includes(item.name);
            const inputType = isRadio ? 'radio' : 'checkbox';
            const costText = item.cost ? `|${item.cost}点` : '';
            const typeText = item.type ? `|${item.type}` : '';
            const label = document.createElement('label');
            label.className = 'skill-option';
            label.style.marginBottom = '8px';
            label.innerHTML = `
              <input type="${inputType}" name="${category}" value="${item.name}" data-cost="${item.cost || 0}" ${isChecked ? 'checked' : ''}>
              <div class="skill-option-content">
                  <span class="skill-main-info">
                      ${item.name} ${typeText} ${costText}
                  </span>
                  <small class="skill-description">${item.description}</small>
              </div>
            `;
            content.appendChild(label);
          });

          groupContainer.appendChild(header);
          groupContainer.appendChild(content);
          elements.modalOptionsList.appendChild(groupContainer);
        });
      }

      function handleModalSelectionChange(event) {
        if (!currentOpenCategory || !event.target.matches('input')) return;

        const input = event.target;
        const itemName = input.value;
        const isRadio = input.type === 'radio';

        if (isRadio) {
          if (input.checked) {
            selections[currentOpenCategory] = [itemName];
          }
        } else {
          const currentSelectionSet = new Set(selections[currentOpenCategory]);
          if (input.checked) {
            currentSelectionSet.add(itemName);
          } else {
            currentSelectionSet.delete(itemName);
          }
          selections[currentOpenCategory] = Array.from(currentSelectionSet);
        }
      }

       function handleModalConfirm() {
        if (!currentOpenCategory) return;
        updateSelectionSummary(currentOpenCategory);

        if (currentOpenCategory === 'backgrounds') {
          updateBackgroundStoryVisibility();
        }

        calculatePoints();
        closeModal();
      }

      function updateSelectionSummary(category) {
        let summaryElement, data, selectedNames;
        let cost = 0;
        let count = 0;

        switch (category) {
          case 'equipments':
            summaryElement = elements.equipmentsSummary;
            data = ALL_POSSIBLE_EQUIPMENTS;
            selectedNames = selections.equipments;
            break;
          case 'items':
            summaryElement = elements.itemsSummary;
            data = ALL_POSSIBLE_ITEMS;
            selectedNames = selections.items;
            break;
          case 'skills':
            summaryElement = elements.skillsSummary;
            data = ALL_POSSIBLE_SKILLS;
            selectedNames = selections.skills;
            break;
          case 'redThreads':
            summaryElement = elements.redThreadsSummary;
            data = ALL_POSSIBLE_RED_THREADS;
            selectedNames = selections.redThreads;
            break;
          case 'backgrounds':
            summaryElement = elements.backgroundsSummary;
            summaryElement.textContent = selections.backgrounds ? `已选: ${selections.backgrounds}` : "未选择";
            return;
        }

        count = selectedNames.length;
        selectedNames.forEach(name => {
          const item = data.find(d => d.name === name);
          if (item) cost += item.cost || 0;
        });

        summaryElement.textContent = `已选${count}件，消耗${cost}点`;
      }

      function openReviewModal() {
        elements.reviewModalOptionsList.innerHTML = '';
        const categoryTitles = {
            equipments: '⚔️ 初始装备',
            items: '🎒 初始物品',
            skills: '💫 技能选择',
            redThreads: '❤️ 初始红线对象',
            backgrounds: '🧭 初始背景'
        };
        Object.keys(categoryTitles).forEach(category => {
            const selectedNames = selections[category];
            if (!selectedNames || (Array.isArray(selectedNames) && selectedNames.length === 0)) {
                return;
            }
            const header = document.createElement('h3');
            header.className = 'review-category-header';
            header.textContent = categoryTitles[category];
            elements.reviewModalOptionsList.appendChild(header);
            const itemsToShow = Array.isArray(selectedNames) ? selectedNames : [selectedNames];
            itemsToShow.forEach(itemName => {
                const itemData = ALL_DATA_SOURCES[category].find(d => d.name === itemName);
                if (!itemData) return;

                const isRadio = category === 'redThreads' || category === 'backgrounds';
                const label = createReviewItemLabel(itemData, category, isRadio);
                elements.reviewModalOptionsList.appendChild(label);
            });
        });

        elements.reviewModal.style.display = 'block';
      }

      function closeReviewModal() {
        elements.reviewModal.style.display = 'none';
      }

      function createReviewItemLabel(item, category, isRadio) {
          const inputType = isRadio ? 'radio' : 'checkbox';
          const costText = item.cost ? `|${item.cost}点` : '';
          const rarityText = item.rarity ? `<span class="rarity-${item.rarity}">【${RARITY_MAP[item.rarity] || item.rarity}】</span>` : '';
          const typeText = item.type ? `|${item.type}` : '';

          const label = document.createElement('label');
          label.className = 'skill-option';
          label.innerHTML = `
              <input type="${inputType}" name="review_${category}" value="${item.name}" data-category="${category}" checked>
              <div class="skill-option-content">
                  <span class="skill-main-info">
                      ${rarityText} ${item.name} ${typeText} ${costText}
                  </span>
                  <small class="skill-description">${item.description}</small>
              </div>
          `;
          return label;
      }

      function handleReviewConfirm() {
          const allInputs = elements.reviewModalOptionsList.querySelectorAll('input');
          const newSelections = { equipments: [], items: [], skills: [], redThreads: [], backgrounds: null };
          allInputs.forEach(input => {
              if (input.checked) {
                  const category = input.dataset.category;
                  const value = input.value;
                  if (Array.isArray(newSelections[category])) {
                      newSelections[category].push(value);
                  } else {
                      newSelections[category] = value;
                  }
              }
          });
          selections = newSelections;
          Object.keys(ALL_DATA_SOURCES).forEach(updateSelectionSummary);
          updateBackgroundStoryVisibility();
          calculatePoints();
          closeReviewModal();
      }

      function calculatePoints() {
        let totalCost = 0;

        const selectedRace = elements.raceInput.value; if (selectedRace && COSTS.race[selectedRace]) totalCost += COSTS.race[selectedRace];
        const selectedIdentity = elements.identityInput.value; if (selectedIdentity && COSTS.identity[selectedIdentity]) totalCost += COSTS.identity[selectedIdentity];
        const selectedLocation = elements.startLocationInput.value; if (selectedLocation && COSTS.startLocation[selectedLocation]) totalCost += COSTS.startLocation[selectedLocation];

        updateAttributes();

        selections.equipments.forEach(name => { const item = ALL_POSSIBLE_EQUIPMENTS.find(d => d.name === name); if (item) totalCost += item.cost; });
        selections.items.forEach(name => { const item = ALL_POSSIBLE_ITEMS.find(d => d.name === name); if (item) totalCost += item.cost; });
        selections.skills.forEach(name => { const item = ALL_POSSIBLE_SKILLS.find(d => d.name === name); if (item) totalCost += item.cost; });
        selections.redThreads.forEach(name => { const item = ALL_POSSIBLE_RED_THREADS.find(d => d.name === name); if (item) totalCost += item.cost; });

        const pointsAfterBaseCosts = baseReincarnationPoints - totalCost;
        const maxDP = Math.max(0, pointsAfterBaseCosts * 10);
        elements.destinyPointsInputSlider.max = maxDP;
        elements.destinyPointsInputNumber.max = maxDP;

        let finalDP;
        if (pointsAfterBaseCosts < 0) {
          finalDP = 0;
          elements.destinyPointsInputSlider.dataset.manualSet = 'false';
        } else if (isInitialLoad || (parseInt(elements.destinyPointsInputNumber.value) === 0 && elements.destinyPointsInputSlider.dataset.manualSet !== 'true')) {
          finalDP = 0;
        } else if (elements.destinyPointsInputSlider.dataset.manualSet !== 'true') {
          finalDP = maxDP;
        } else {
          let currentChosenDP = parseInt(elements.destinyPointsInputNumber.value) || 0;
          finalDP = Math.min(currentChosenDP, maxDP);
        }

        elements.destinyPointsInputNumber.value = finalDP;
        elements.destinyPointsInputSlider.value = finalDP;

        const rpSpentOnDestiny = finalDP / 10;
        currentReincarnationPoints = Math.round(pointsAfterBaseCosts - rpSpentOnDestiny);
        updatePointsDisplay();
      }

      function updatePointsDisplay() {
        document.getElementById('reincarnationPointsDisplay').textContent = currentReincarnationPoints;
        document.querySelectorAll('.reincarnation-points-value').forEach(span => span.textContent = currentReincarnationPoints);
        document.querySelector('.reincarnation-points').style.color = currentReincarnationPoints < 0 ? '#ff0000' : 'var(--points-color)';
      }

      function renderAttributeControls() {
        let pressTimer;
        function startPress(isPlus, stat) {
          stopPress(); let currentDelay = 200, minDelay = 30, accelerationFactor = 0.85;
          function step() { if (handleAPChange(isPlus, stat)) { currentDelay = Math.max(minDelay, currentDelay * accelerationFactor); pressTimer = setTimeout(step, currentDelay); } }
          if (handleAPChange(isPlus, stat)) { pressTimer = setTimeout(step, 500); }
        }
        function stopPress() { clearTimeout(pressTimer); }
        function handleAPChange(isPlus, stat) {
          const remainingAP = getRemainingAP(); let changed = false;
          if (isPlus && remainingAP > 0) { attributePoints[stat]++; changed = true; }
          else if (!isPlus && attributePoints[stat] > 0) { attributePoints[stat]--; changed = true; }
          updateAttributes(); return changed;
        }
        elements.attributesContainer.innerHTML = '';
        attributes.forEach(attr => {
          attributePoints[attr] = 0;
          elements.attributesContainer.insertAdjacentHTML('beforeend', `<div class="attribute-control" data-attribute="${attr}"><span class="stat-name">${attr}</span><span class="stat-value" id="${attr}Total">4</span><div class="ap-buttons"><button class="ap-btn minus" data-stat="${attr}">-</button><input type="number" class="ap-input" id="${attr}AP" value="0" min="0" readonly><button class="ap-btn plus" data-stat="${attr}">+</button></div></div>`);
        });
        document.querySelectorAll('.ap-btn').forEach(button => {
          const stat = button.dataset.stat, isPlus = button.classList.contains('plus');
          button.addEventListener('mousedown', e => startPress(isPlus, stat));
          button.addEventListener('mouseup', stopPress); button.addEventListener('mouseleave', stopPress);
          button.addEventListener('touchstart', e => { e.preventDefault(); startPress(isPlus, stat); });
          button.addEventListener('touchend', stopPress);
        });
      }

      function getRemainingAP() {
        const availableAP = 5;
        const totalAllocatedAP = Object.values(attributePoints).reduce((sum, points) => sum + points, 0);
        return availableAP - totalAllocatedAP;
      }

      function updateAttributes() {
        const baseStat = 4;
        const availableAP = 5;
        let totalAllocatedAP = Object.values(attributePoints).reduce((sum, points) => sum + points, 0);
        if (totalAllocatedAP > availableAP) { attributes.forEach(attr => { attributePoints[attr] = 0; }); totalAllocatedAP = 0; }
        const remainingAP = availableAP - totalAllocatedAP;
        elements.apDisplay.textContent = remainingAP;
        attributes.forEach(attr => {
          const allocated = attributePoints[attr] || 0;
          const total = baseStat + allocated;
          document.getElementById(`${attr}Total`).textContent = total;
          document.getElementById(`${attr}AP`).value = allocated;
          const plusBtn = document.querySelector(`.ap-btn.plus[data-stat="${attr}"]`), minusBtn = document.querySelector(`.ap-btn.minus[data-stat="${attr}"]`);
          if (plusBtn) plusBtn.disabled = remainingAP <= 0; if (minusBtn) minusBtn.disabled = allocated <= 0;
        });
      }

      function randomizeAP() {
        attributes.forEach(attr => { attributePoints[attr] = 0; });
        let remainingAPToAllocate = getRemainingAP();
        while (remainingAPToAllocate > 0) {
          const randomStat = attributes[Math.floor(Math.random() * attributes.length)];
          attributePoints[randomStat]++; remainingAPToAllocate--;
        }
        updateAttributes();
      }

      function updateBackgroundAvailabilityInModal() {
        const selectedLocation = elements.startLocationInput.value;
        const selectedRace = elements.raceInput.value;
        const taskRadios = elements.modalOptionsList.querySelectorAll('input[name="backgrounds"]');
        taskRadios.forEach(radio => {
          const taskData = ALL_POSSIBLE_BACKGROUNDS.find(t => t.name === radio.value);
          const label = radio.closest('.skill-option');
          if (!taskData) return;
          const locationMatch = !taskData.requiredLocation || taskData.requiredLocation === selectedLocation;
          const raceMatch = !taskData.requiredRace || taskData.requiredRace === selectedRace;
          radio.disabled = !(locationMatch && raceMatch);
          label.style.opacity = radio.disabled ? '0.5' : '1';
          label.style.cursor = radio.disabled ? 'not-allowed' : 'pointer';
          if (radio.disabled && radio.checked) {
            radio.checked = false;
            selections.backgrounds = null;
            updateSelectionSummary('backgrounds');
          }
        });
      }

      function setupCustomInput(select, customInput) {
        select.addEventListener('change', () => {
          customInput.classList.toggle('show', select.value === 'custom');
          if (select.value !== 'custom') customInput.value = '';
          calculatePoints();
        });
        customInput.addEventListener('input', calculatePoints);
      }

      function randomizeAll() {
        resetAll();
        function randomizeSelect(selectElement) {
          const options = Array.from(selectElement.options).filter(opt => opt.value && opt.value !== 'custom' && !opt.disabled);
          if (options.length > 0) {
            selectElement.value = options[Math.floor(Math.random() * options.length)].value;
            selectElement.dispatchEvent(new Event('change'));
          }
        }
        elements.genderInput.value = ['男', '女'][Math.floor(Math.random() * 2)];
        randomizeSelect(elements.raceInput);
        randomizeSelect(elements.identityInput);
        randomizeSelect(elements.startLocationInput);
        elements.ageInput.value = Math.floor(Math.random() * 51) + 16;
        randomizeAP();

        calculatePoints();
        let remainingPoints = currentReincarnationPoints;

        const selectionCategories = {
          equipments: ALL_POSSIBLE_EQUIPMENTS,
          items: ALL_POSSIBLE_ITEMS,
          skills: ALL_POSSIBLE_SKILLS,
        };

        for (const category in selectionCategories) {
          const dataPool = selectionCategories[category];
          const targetCount = Math.floor(Math.random() * 3) + 1;
          let pickedCount = 0;
          const shuffledPool = [...dataPool].sort(() => 0.5 - Math.random());
          for (const item of shuffledPool) {
            if (pickedCount >= targetCount) break;
            if (remainingPoints >= item.cost) {
              selections[category].push(item.name);
              remainingPoints -= item.cost;
              pickedCount++;
            }
          }
          updateSelectionSummary(category);
        }

        const availableBackgrounds = ALL_POSSIBLE_BACKGROUNDS.filter(task => {
          const locationMatch = !task.requiredLocation || task.requiredLocation === elements.startLocationInput.value;
          const raceMatch = !task.requiredRace || task.requiredRace === elements.raceInput.value;
          return locationMatch && raceMatch;
        });
        if (availableBackgrounds.length > 0) {
          selections.backgrounds = availableBackgrounds[Math.floor(Math.random() * availableBackgrounds.length)].name;
          updateSelectionSummary('backgrounds');
        }
        updateBackgroundStoryVisibility();
        elements.destinyPointsInputSlider.dataset.manualSet = 'false';
        calculatePoints();
      }

      function resetAll() {
        ['nameInput', 'ageInput', 'customGenderInput', 'customRaceInput', 'customIdentityInput', 'customStartLocationInput', 'backgroundStory'].forEach(id => {
          elements[id].value = '';
          if (elements[id].classList.contains('custom-input')) elements[id].classList.remove('show');
        });
        ['genderInput', 'raceInput', 'identityInput', 'startLocationInput'].forEach(id => {
          elements[id].value = '';
          elements[id].dispatchEvent(new Event('change'));
        });

        attributePoints = {};
        attributes.forEach(attr => { attributePoints[attr] = 0; });
        selections = { equipments: [], items: [], skills: [], redThreads: [], backgrounds: null };

        updateBackgroundStoryVisibility();
        ['equipments', 'items', 'skills', 'redThreads', 'backgrounds'].forEach(updateSelectionSummary);
        elements.destinyPointsInputSlider.value = 0;
        elements.destinyPointsInputNumber.value = 0;
        elements.destinyPointsInputSlider.dataset.manualSet = 'false';

        baseReincarnationPoints = INITIAL_REINCARNATION_POINTS;
        calculatePoints();
      }

      function randomizePoints() {
        baseReincarnationPoints = Math.floor(100 + (Math.pow(Math.random(), 3) * (666 - 100)));
        calculatePoints();
      }

      setupCustomInput(elements.genderInput, elements.customGenderInput);
      setupCustomInput(elements.raceInput, elements.customRaceInput);
      setupCustomInput(elements.identityInput, elements.customIdentityInput);
      setupCustomInput(elements.startLocationInput, elements.customStartLocationInput);

      elements.levelInputSlider.addEventListener('input', () => { elements.levelInputNumber.value = elements.levelInputSlider.value; calculatePoints(); });
      elements.levelInputNumber.addEventListener('input', () => { let val = parseInt(elements.levelInputNumber.value) || 1; val = Math.max(1, Math.min(val, parseInt(elements.levelInputSlider.max))); elements.levelInputNumber.value = val; elements.levelInputSlider.value = val; calculatePoints(); });

      ['destinyPointsInputSlider', 'destinyPointsInputNumber'].forEach(id => {
        elements[id].addEventListener('input', () => {
          const isSlider = id.includes('Slider');
          const source = isSlider ? elements.destinyPointsInputSlider : elements.destinyPointsInputNumber;
          const target = isSlider ? elements.destinyPointsInputNumber : elements.destinyPointsInputSlider;
          target.value = source.value;
          elements.destinyPointsInputSlider.dataset.manualSet = 'true';
          calculatePoints();
        });
      });

      ['raceInput', 'identityInput', 'startLocationInput'].forEach(id => elements[id].addEventListener('change', calculatePoints));
      elements.raceInput.addEventListener('change', () => { if (selections.backgrounds) { selections.backgrounds = null; updateSelectionSummary('backgrounds'); updateBackgroundStoryVisibility(); } });
      elements.startLocationInput.addEventListener('change', () => { if (selections.backgrounds) { selections.backgrounds = null; updateSelectionSummary('backgrounds'); updateBackgroundStoryVisibility(); } });

      document.querySelectorAll('.selection-btn').forEach(btn => {
        if (btn.id === 'reviewButton') return;
        btn.addEventListener('click', () => openModal(btn.dataset.category));
      });
      elements.modalConfirmBtn.addEventListener('click', handleModalConfirm);
      elements.closeBtn.addEventListener('click', closeModal);
      window.addEventListener('click', (e) => { if (e.target == elements.modal) closeModal(); });

      elements.randomizeAllButton.addEventListener('click', randomizeAll);
      elements.resetButton.addEventListener('click', resetAll);
      elements.randomizeAttributesButton.addEventListener('click', randomizeAP);
      elements.randomizePointsButton.addEventListener('click', randomizePoints);
      elements.modalOptionsList.addEventListener('change', handleModalSelectionChange);
      elements.modalOptionsList.addEventListener('click', (event) => {
        const header = event.target.closest('.accordion-header');
        if (!header) return;
        const currentGroup = header.parentElement;
        const isAlreadyActive = currentGroup.classList.contains('active');
        elements.modalOptionsList.querySelectorAll('.accordion-group').forEach(group => {
          group.classList.remove('active');
        });
        if (!isAlreadyActive) {
          currentGroup.classList.add('active');
        }
      });

      elements.reviewButton.addEventListener('click', openReviewModal);
      elements.reviewCloseBtn.addEventListener('click', closeReviewModal);
      elements.reviewModalConfirmBtn.addEventListener('click', handleReviewConfirm);
      window.addEventListener('click', (e) => {
        if (e.target == elements.modal) closeModal();
        if (e.target == elements.reviewModal) closeReviewModal();
      });
      elements.sendButton.addEventListener('click', async () => {
        const getSelectedObjects = (category, sourceData) => selections[category].map(name => sourceData.find(d => d.name === name) || { name });
        const inputs = {
          name: elements.nameInput, gender: elements.genderInput, customGender: elements.customGenderInput,
          age: elements.ageInput, backgroundStory: elements.backgroundStory,
          race: elements.raceInput, customRace: elements.customRaceInput,
          identity: elements.identityInput, customIdentity: elements.customIdentityInput,
          startLocation: elements.startLocationInput, customStartLocation: elements.customStartLocationInput,
          level: 1, // Level is fixed
          destinyPoints: elements.destinyPointsInputNumber,
          selectedEquipmentObjects: getSelectedObjects('equipments', ALL_POSSIBLE_EQUIPMENTS),
          selectedItemObjects: getSelectedObjects('items', ALL_POSSIBLE_ITEMS),
          selectedSkillObjects: getSelectedObjects('skills', ALL_POSSIBLE_SKILLS),
          selectedRedThreadObjects: getSelectedObjects('redThreads', ALL_POSSIBLE_RED_THREADS), // FIX: This line was added
          selectedBackgroundObject: ALL_POSSIBLE_BACKGROUNDS.find(t => t.name === selections.backgrounds), // FIX: Duplicate key removed
          unallocatedAP: getRemainingAP(),
          attributes: attributes.reduce((obj, attr) => { obj[attr] = 4 + (attributePoints[attr] || 0); return obj; }, {}),
        };


        let name = inputs.name.value.trim() || '无名者';
        const gender = inputs.gender.value === 'custom' ? inputs.customGender.value.trim() : inputs.gender.value;
        const age = inputs.age.value.trim();
        const race = inputs.race.value === 'custom' ? inputs.customRace.value.trim() : inputs.race.value;
        const identity = inputs.identity.value === 'custom' ? inputs.customIdentity.value.trim() : inputs.identity.value;
        const startLocation = inputs.startLocation.value === 'custom' ? inputs.customStartLocation.value.trim() : inputs.startLocation.value;
        const backgroundStory = inputs.backgroundStory.value.trim();
        const level = inputs.level;
        const selectedBackgroundName = selections.backgrounds;

        let missing = [];
        if (selectedBackgroundName === '【自定义开局】' && !backgroundStory) {
          alert('你选择了“自定义开局”，请在“你的初始背景故事”一栏中填写你的故事。');
          elements.backgroundStory.focus();
          return;
        }
        if (!selections.backgrounds && !backgroundStory) missing.push('初始背景或背景故事');
        if (!gender) missing.push('性别'); if (!age) missing.push('年龄'); if (!race) missing.push('种族');
        if (!identity) missing.push('身份'); if (!startLocation) missing.push('起始地点');

        if (missing.length > 0) { alert(`档案中的 ${missing.join('、')} 是开启旅程的钥匙，请务必填写完整。`); return; }
        if (currentReincarnationPoints < 0) { alert(`转生点不足！你还需要 ${Math.abs(currentReincarnationPoints)}点。`); return; }

        const formatted = (label, objects) => {
          if (objects.length === 0) return `${label}: 无`;
          return `${label}:\n` + objects.map(o => `- ${o.type || ''}:${o.name}(${RARITY_MAP[o.rarity] || o.rarity || ''}) - ${o.description}`).join('\n');
        };

        let storyHook = "";
        if (backgroundStory) {
          storyHook = `\n背景故事: ${backgroundStory}`;
        } else if (inputs.selectedBackgroundObject) {
          storyHook = `\n初始背景: ${inputs.selectedBackgroundObject.name} - ${inputs.selectedBackgroundObject.description}`;
        }

        let finalDestinyPoints = parseInt(inputs.destinyPoints.value);
        if (currentReincarnationPoints > 0) {
          finalDestinyPoints += currentReincarnationPoints * 10;
        }

        let message = `角色初始信息：\n` +
          `姓名: ${name}\n性别: ${gender}\n年龄: ${age}\n种族: ${race}\n身份: ${identity}\n起始地点: ${startLocation}\n` +
          `生命层级: 第一层级/普通层级\n` +
          `初始等级: ${level}\n` +
          `初始属性: (力量: ${inputs.attributes['力量']}, 敏捷: ${inputs.attributes['敏捷']}, 体质: ${inputs.attributes['体质']}, 智力: ${inputs.attributes['智力']}, 精神: ${inputs.attributes['精神']})\n` +
          `未分配属性点: ${inputs.unallocatedAP}\n\n` +
          `${formatted('初始装备', inputs.selectedEquipmentObjects)}\n\n` +
          `${formatted('初始物品', inputs.selectedItemObjects)}\n\n` +
          `${formatted('初始技能', inputs.selectedSkillObjects)}\n\n` +
          `初始红线对象:\n${inputs.selectedRedThreadObjects.map(o => `- ${o.name} - ${o.description}`).join('\n') || '无'}\n\n` +
          `${storyHook}\n\n` +
          `- 命运点数: ${finalDestinyPoints}`;
        message += `\n\n(生成开局时，完整保留装备、物品、技能和红线对象的描述，严禁任何修改和省略，将其直接添加到系统中)`;

        if (typeof triggerSlash !== 'undefined') {
          triggerSlash(`/send ${message}`);
          elements.sendButton.textContent = '已发送!';
          setTimeout(() => { elements.sendButton.textContent = '踏上旅程'; }, 2000);
        } else {
          console.log('SillyTavern API未找到。');
          console.log(message);
          alert('未在SillyTavern环境中运行。请在控制台查看生成的数据。');
        }
      });

      renderAttributeControls();
      calculatePoints();
      updatePointsDisplay();
      updateBackgroundStoryVisibility();
      isInitialLoad = false;
    });
  </script>
</body>

</html>