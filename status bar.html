<!DOCTYPE html>
<html lang="zh-CN">
 <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>冒险状态</title>
  <style>
   /* 导入外部字体，用于营造奇幻风格 */
   @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Merriweather:ital,wght@0,400;0,700;1,400&family=Noto+Sans+SC:wght@400;500;700&display=swap');

   /* --- 基础样式 --- */
   body {
    font-family: 'Noto Sans SC', 'Merriweather', serif;
    background-color: #f5efe6;
    color: #4a3b31;
    margin: 0;
    padding: 15px;
    background-repeat: repeat;
    background-image: url('https://www.transparenttextures.com/patterns/handmade-paper.png');
    background-size: cover;
    background-attachment: fixed;
   }

   /* --- 主容器样式 --- */
   .status-scroll {
    border: 2px solid #785a4e;
    border-radius: 8px;
    padding: 20px;
    background-color: rgba(240, 230, 210, 0.85);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25), inset 0 0 10px rgba(0, 0, 0, 0.05);
    max-width: 900px;
    margin: auto;
    position: relative;
    overflow: hidden;
   }

   /* --- 顶部信息框 (时间和地点) --- */
   .time-location-box {
    background-color: #e8ddcb;
    padding: 10px 15px;
    border-radius: 4px;
    margin-bottom: 15px;
    border: 1px solid #c6b8a5;
    text-align: left;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
   }
   .time-location-box:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
   }

   /* --- 通用数值样式 --- */
   .value-main {
    font-weight: 500;
    font-family: 'Noto Sans SC', 'Courier New', monospace;
    text-shadow: 0 0 2px rgba(0, 0, 0, 0.15), 0 0 5px rgba(255, 255, 255, 0.3);
   }

   /* --- 品质颜色 --- */
   .quality-mythic {
    color: #d32f2f;
    font-weight: bold;
   }
   .quality-legendary {
    color: #9E7121;
    font-weight: bold;
   }
   .quality-epic {
    color: #9C27B0;
    font-weight: bold;
   }
   .quality-rare {
    color: #193C96;
    font-weight: bold;
   }
   .quality-uncommon {
    color: #388E3C;
    font-weight: bold;
   }
   .quality-common {
    /* No special color, inherits default */
   }

   /* --- 折叠面板 (details/summary) 基础样式 --- */
   details.section,
   details.sub-section,
   details.task-entry,
   details.skill-entry,
   details.destiny-target,
   details.inventory-item-entry {
    margin-bottom: 6px;
    border: 1px solid #d3c5b3;
    border-radius: 4px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease-in-out;
   }
   details.section:hover,
   details.sub-section:hover,
   details.task-entry:hover,
   details.skill-entry:hover,
   details.destiny-target:hover,
   details.inventory-item-entry:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
   }

  /* --- 折叠面板标题 (summary) --- */
  details > summary {
  font-family: 'Cinzel', serif;
  font-weight: 700;
  color: #5d4037;
  background-color: #d7c8b6;
  padding: 4px 15px;
  cursor: pointer;
  list-style: none;
  display: flex;
  align-items: center;
  border-bottom: 1px solid #c6b8a5;
  text-align: left;
  transition: background-color 0.2s ease, color 0.2s ease;
  }
   details > summary::-webkit-details-marker {
    display: none;
   }
   details > summary:hover {
    background-color: #cbb8a5;
    color: #4a3b31;
   }
   details[open] > summary {
    background-color: #bfa996;
    border-bottom-color: #a39281;
   }

   /* --- 折叠面板标题左侧的发光星星图标 --- */
   details > summary::before {
    content: '✦';
    font-size: 1.1em;
    color: #a39281;
    text-shadow: none;
    margin-right: 12px;
    flex-shrink: 0;
    transform-origin: center center;
    transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55), color 0.4s ease, text-shadow 0.4s ease;
   }
   details[open] > summary::before {
    transform: rotate(360deg);
    color: #f7d75a;
    text-shadow: 0 0 3px rgba(255, 255, 255, 0.8), 0 0 6px #f7d75a, 0 0 10px #e5a50a;
   }

   /* --- 折叠面板右侧的折叠箭头 --- */
   .arrow-toggle {
    transition: transform 0.2s ease-in-out;
    font-size: 0.8em;
    padding-left: 5px;
    margin-left: auto;
   }
   details[open] > summary .arrow-toggle {
    transform: rotate(90deg);
   }

   /* --- 折叠面板内容区域 --- */
   .section-content,
   .sub-section-content,
   .task-content,
   .skill-description,
   .destiny-target-content,
   .inventory-item-details {
    padding: 15px;
    background-color: rgba(253, 250, 245, 0.9);
    text-align: left;
    font-size: 0.9em;
    transition: background-color 0.2s ease, padding 0.2s ease, box-shadow 0.2s ease;
   }
   .skill-description,
   .passive-skill-item {
    padding-top: 5px;
    padding-bottom: 5px;
   }
   .inventory-item-details {
    padding: 10px 15px;
   }

   /* --- 内容区域通用样式 --- */
   .property,
   .equipment-slot,
   .inventory-category,
   .currency-item {
    margin-bottom: 8px;
    line-height: 1.6;
   }
   .property-name,
   .equipment-slot p:first-child,
   .inventory-category p:first-child {
    font-weight: bold;
    color: #6a514d;
    text-shadow: 0 0 1px rgba(0, 0, 0, 0.08);
   }
   .equip-description,
   .passive-skill-description,
   .title-effect {
    font-size: 0.85em;
    font-style: italic;
    color: #7a655d;
    padding-left: 10px;
    margin-top: 2px;
   }
   .currency-item {
    padding-left: 15px;
   }

   /* --- 进度条样式 --- */
   .progress-bar-container {
    background-color: #c8bbaf;
    border-radius: 9px;
    height: 18px;
    margin-top: 4px;
    margin-bottom: 8px;
    overflow: hidden;
    border: 1px solid rgba(0, 0, 0, 0.15);
    box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.2);
   }
   .progress-bar-value {
    height: 100%;
    width: 0%;
    transition: width 0.8s ease-out;
    border-radius: 9px;
    text-align: center;
    color: white;
    font-size: 0.7em;
    line-height: 18px;
    background-image: linear-gradient(to bottom, rgba(255,255,255,0.15), rgba(0,0,0,0.1));
    box-shadow: inset 0 -1px 3px rgba(0,0,0,0.1);
   }

   /* --- 分隔线样式 --- */
   .thin-divider {
    border: 0;
    margin: 10px 0;
    background: transparent url("data:image/svg+xml,%3Csvg width='100%25' height='1' viewBox='0 0 100 1' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cline x1='0' y1='0.5' x2='100' y2='0.5' stroke='%23B3A291' stroke-dasharray='3 3'/%3E%3C/svg%3E") repeat-x center;
    border-top: none;
    height: 1px;
   }

   /* --- 特定区域微调 --- */
   .bonds-skill-section {
    margin-top: 10px;
   }

   /* --- 登神长阶专属样式 --- */
   .step-level-req {
    font-size: 0.8em;
    color: #7a655d;
    font-style: italic;
    margin-left: 15px;
   }
   .step-item {
     margin-bottom: 5px;
     line-height: 1.6;
   }
   .item-name {
     font-weight: bold;
     color: #6d4c41;
   }
   .item-desc {
     font-size: 0.9em;
     font-style: italic;
     color: #7a655d;
     margin-left: 20px;
     display: block; /* 确保换行 */
   }
   .empty-slot {
     color: #9e9e9e;
     font-style: italic;
   }
   .god-tier-grid {
     display: grid;
     grid-template-columns: 1fr 1fr;
     gap: 20px;
   }
   /* 未解锁状态 */
   details.sub-section.locked > summary {
    background-color: #e8e4e0;
    color: #b5aaa2;
    cursor: not-allowed;
   }
   details.sub-section.locked > summary::before {
    content: '🔒';
    color: #b5aaa2;
   }


   /* --- 新闻版块标题样式 --- */
   .news-headline {
    font-weight: 700;
   }
   .news-gold-lion {
    font-family: 'Cinzel', serif;
    color: #b9892d;
   }
   .news-tavern {
    font-family: 'Merriweather', serif;
    color: #6d4c41;
   }
   .news-wonders {
    font-family: 'Merriweather', serif;
    font-style: italic;
    color: #5c6bc0;
   }
   .news-tea-party {
    font-family: 'Cinzel', serif;
    color: #c2185b;
   }

   /* --- 隐藏元素的通用类 --- */
   .hidden {
    display: none !important;
   }

   /* --- 即时状态列表样式 --- */
   .instant-status-item {
    margin-left: 15px;
    font-size: 0.9em;
    color: #4a3b31;
    line-height: 1.5;
    white-space: pre-wrap;
   }
   .instant-status-item span.status-name {
    font-weight: bold;
    color: #6a514d;
   }

   /* --- 布局网格 (Grid) --- */
   .status-grid {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 20px;
    align-items: start;
   }
   .status-grid-left,
   .status-grid-right {
    display: flex;
    flex-direction: column;
    gap: 8px;
   }
   .vertical-divider {
    width: 1px;
    background-color: #d3c5b3;
    align-self: stretch;
    margin: 0 5px;
    background: transparent url("data:image/svg+xml,%3Csvg width='1' height='100%25' viewBox='0 0 1 100' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cline x1='0.5' y1='0' x2='0.5' y2='100' stroke='%23D3C5B3' stroke-dasharray='3 3'/%3E%3C/svg%3E") repeat-y center;
   }

   /* --- 交互元素 (按钮) --- */
   .action-button {
    background-color: #8d6e63;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'Noto Sans SC', sans-serif;
    font-size: 0.9em;
    margin-bottom: 10px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    transition: all 0.2s ease;
   }
   .action-button:hover {
    background-color: #6d4c41;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    transform: translateY(-2px);
   }
   .action-button:active {
    transform: translateY(1px);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
   }

   @media (max-width: 768px) {
    .status-grid {
     grid-template-columns: 1fr;
     gap: 10px;
    }
    .vertical-divider {
     display: none;
    }
    .status-grid-right {
     border-top: 1px solid #d3c5b3;
     padding-top: 10px;
    }
   }

   /* --- 折叠栏标题中间的动态信息样式 --- */
   .summary-details {
    margin-left: auto; /* 核心：将此元素推到右边 */
    padding-right: 15px; /* 与右侧箭头保持距离 */
    font-family: 'Noto Sans SC', 'Courier New', monospace; /* 使用数值字体 */
    font-weight: 500;
    font-size: 0.8em;
    color: #6a514d; /* 使用比标题稍浅的颜色 */
    letter-spacing: 0.5px;
    text-shadow: 0 0 1px rgba(0, 0, 0, 0.05);
    align-self: center; /* 垂直居中对齐 */
   }

/* 为角色背包中的单个物品条目创建了独立的样式规则 */
details.inventory-item-entry > summary {
  padding-top: 0.8px;
  padding-bottom: 0.8px;
  font-size: 0.9em;
}
  </style>
 </head>
 <body>
  <!-- 主容器 -->
  <div class="status-scroll">
   <!-- 时间和地点 -->
   <div class="time-location-box">
    <p>⏳️ 时间: <span id="world-time" class="value-main"></span></p>
    <p>📍 地点: <span id="world-location" class="value-main"></span></p>
   </div>

   <!-- 登神长阶 -->
   <details class="section" id="ascension-section">
    <summary>♾️ 登神长阶 <span class="summary-details" id="ascension-summary-details"></span><span class="arrow-toggle">▼</span></summary>
    <div class="section-content">

     <!-- 要素 -->
     <details class="sub-section" id="ascension-elements-details">
      <summary>要素 <span class="step-level-req">60级开启</span><span class="arrow-toggle">▼</span></summary>
      <div class="sub-section-content">
       <div id="ascension-elements-list"></div>
       <p class="empty-slot hidden" id="no-elements-msg">（尚无要素）</p>
      </div>
     </details>
     <!-- 权能 -->
     <details class="sub-section" id="ascension-authority-details">
      <summary>权能 <span class="step-level-req">80级开启</span><span class="arrow-toggle">▼</span></summary>
      <div class="sub-section-content">
       <div id="ascension-authority-list"></div>
       <p class="empty-slot hidden" id="no-authority-msg">（尚无权能）</p>
      </div>
     </details>
     <!-- 法则 -->
     <details class="sub-section" id="ascension-laws-details">
      <summary>法则 <span class="step-level-req">90级开启</span><span class="arrow-toggle">▼</span></summary>
      <div class="sub-section-content">
       <div id="ascension-laws-list"></div>
       <p class="empty-slot hidden" id="no-laws-msg">（尚无法则）</p>
      </div>
     </details>
     <!-- 神位 / 神国 -->
     <details class="sub-section" id="ascension-divinity-details">
      <summary>神位 / 神国 <span class="step-level-req">100级开启</span><span class="arrow-toggle">▼</span></summary>
      <div class="sub-section-content">
       <div class="god-tier-grid">
         <div>
           <div class="step-item">
             <span class="item-name">神位: </span>
             <span class="value-main" id="ascension-divinity-name"></span>
             <span class="empty-slot hidden" id="divinity-empty-slot">（尚未登临）</span>
           </div>
         </div>
         <div>
           <div class="step-item">
             <span class="item-name">神国: </span>
             <span class="value-main" id="ascension-kingdom-name"></span>
             <span class="empty-slot hidden" id="kingdom-empty-slot">（尚未开辟）</span>
           </div>
         </div>
       </div>
      </div>
     </details>
    </div>
   </details>


   <!-- 当前任务 -->
   <details class="section" id="tasks-section">
    <summary>📜 当前任务 <span class="summary-details" id="tasks-summary-details"></span><span class="arrow-toggle">▼</span></summary>
    <div class="section-content">
     <div id="tasks-list-container"></div>
     <p id="no-tasks-msg" class="hidden">（暂无任务）</p>
    </div>
   </details>

   <!-- 角色信息与状态 -->
  <details class="section" id="character-status-section">
  <summary>👤 角色信息与状态 <span class="summary-details" id="character-status-summary-details"></span><span class="arrow-toggle">▼</span></summary>
  <div class="section-content">
    <!-- 资源条: HP, MP, SP, EXP -->
    <div class="property">
    <span class="property-name">❤️ HP:</span>
    <span id="char-hp" class="value-main"></span> / <span id="char-hp-max" class="value-main"></span>
    <div class="progress-bar-container"><div id="char-hp-bar" class="progress-bar-value"></div></div>
    </div>
    <div class="property">
    <span class="property-name">🔮 MP:</span>
    <span id="char-mp" class="value-main"></span> / <span id="char-mp-max" class="value-main"></span>
    <div class="progress-bar-container"><div id="char-mp-bar" class="progress-bar-value"></div></div>
    </div>
    <div class="property">
    <span class="property-name">⚡ SP:</span>
    <span id="char-sp" class="value-main"></span> / <span id="char-sp-max" class="value-main"></span>
    <div class="progress-bar-container"><div id="char-sp-bar" class="progress-bar-value"></div></div>
    </div>
    <div class="property">
    <span class="property-name">累计经验:</span> <span id="char-exp" class="value-main"></span> /
    <span id="char-exp-needed" class="value-main"></span>
    <div class="progress-bar-container"><div id="char-exp-bar" class="progress-bar-value"></div></div>
    </div>
    <hr class="thin-divider" />
  <!-- 状态网格布局 -->
  <div class="status-grid">
  <!-- 左侧：战力层级、等级、种族、身份、职业、状态、称号等 -->
  <div class="status-grid-left">
   <p><span class="property-name">⚜️ 战力层级:</span> <span id="char-power-level" class="value-main"></span></p>
   <p><span class="property-name">✨ 等级:</span> <span id="char-level" class="value-main"></span></p>
   <p><span class="property-name">🧬 种族:</span> <span id="char-race" class="value-main"></span></p>
   <p><span class="property-name">👑 身份:</span> <span id="char-identity" class="value-main">(暂无)</span></p>
   <p><span class="property-name">⚖️ 职业:</span> <span id="char-occupation" class="value-main">(暂无)</span></p>
   <hr class="thin-divider" />
   <p>
   <span class="property-name">🔥 冒险者等级:</span>
   <span id="char-adventurer-rank" class="value-main">(未评级)</span>
   </p>
   <p><span class="property-name">🏆 称号:</span> <span id="char-title" class="value-main">(无)</span></p>
   <div class="title-effect">(<span id="char-title-effect" class="value-main">无</span>)</div>
  </div>
  <!-- 分隔线 -->
  <div class="vertical-divider"></div>
  <!-- 右侧：属性点和五维属性 -->
  <div class="status-grid-right">
   <p><span class="property-name">属性点 AP:</span> <span id="char-ap" class="value-main"></span></p>

   <!-- 属性正常显示容器 -->
   <div id="ap-display-container">
   <p><span class="property-name">💪 力量 STR:</span> <span id="char-str-display" class="value-main"></span></p>
   <p><span class="property-name">🤸 敏捷 AGI:</span> <span id="char-agi-display" class="value-main"></span></p>
   <p><span class="property-name">🏋️ 体质 CON:</span> <span id="char-con-display" class="value-main"></span></p>
   <p><span class="property-name">🧠 智力 INT:</span> <span id="char-int-display" class="value-main"></span></p>
   <p><span class="property-name">🧘 精神 SPI:</span> <span id="char-spi-display" class="value-main"></span></p>
   </div>

   <hr class="thin-divider" />
   <div class="property">
    <span class="property-name">🔘 即时状态:</span>
    <div id="char-instant-status-container"></div>
    <p id="no-instant-status-msg" class="value-main">(正常)</p>
   </div>
  </div>
  </div>
  </div>
  </details>

<details class="section" id="character-equipment-section">
<summary>⚔️ 角色装备 <span class="arrow-toggle">▼</span></summary>
<div class="section-content">
  <div class="equipment-slot" id="equip-weapon-slot">
  <p>🗡️ 主武器: <span id="equip-weapon-name" class="value-main">无装备</span></p>
  <p class="equip-description hidden" id="equip-weapon-desc-p">
    <span id="equip-weapon-desc" class="value-main"></span>
  </p>
  </div>
  <hr class="thin-divider" />
  <div class="equipment-slot" id="equip-offhand-slot">
  <p>🛡️ 副武器: <span id="equip-offhand-name" class="value-main">无装备</span></p>
  <p class="equip-description hidden" id="equip-offhand-desc-p">
    <span id="equip-offhand-desc" class="value-main"></span>
  </p>
  </div>
  <hr class="thin-divider" />
  <div class="equipment-slot" id="equip-body-slot">
  <p>🧥 身体: <span id="equip-body-name" class="value-main">无装备</span></p>
  <p class="equip-description hidden" id="equip-body-desc-p">
    <span id="equip-body-desc" class="value-main"></span>
  </p>
  </div>
  <hr class="thin-divider" />
  <div class="equipment-slot" id="equip-head-slot">
  <p>🎓 头部防具: <span id="equip-head-name" class="value-main">无装备</span></p>
  <p class="equip-description hidden" id="equip-head-desc-p">
    <span id="equip-head-desc" class="value-main"></span>
  </p>
  </div>
  <hr class="thin-divider" />
  <div class="equipment-slot" id="equip-hands-slot">
  <p>🧤 手部防具: <span id="equip-hands-name" class="value-main">无装备</span></p>
  <p class="equip-description hidden" id="equip-hands-desc-p">
    <span id="equip-hands-desc" class="value-main"></span>
  </p>
  </div>
  <hr class="thin-divider" />
  <div class="equipment-slot" id="equip-feet-slot">
  <p>👢 脚部防具: <span id="equip-feet-name" class="value-main">无装备</span></p>
  <p class="equip-description hidden" id="equip-feet-desc-p">
    <span id="equip-feet-desc" class="value-main"></span>
  </p>
  </div>
  <hr class="thin-divider" />
  <div class="equipment-slot" id="equip-acc1-slot">
  <p>💍 饰品1: <span id="equip-acc1-name" class="value-main">无装备</span></p>
  <p class="equip-description hidden" id="equip-acc1-desc-p">
    <span id="equip-acc1-desc" class="value-main"></span>
  </p>
  </div>
  <hr class="thin-divider" />
  <div class="equipment-slot" id="equip-acc2-slot">
  <p>📿 饰品2: <span id="equip-acc2-name" class="value-main">无装备</span></p>
  <p class="equip-description hidden" id="equip-acc2-desc-p">
    <span id="equip-acc2-desc" class="value-main"></span>
  </p>
  </div>
</div>
</details>

  <details class="section" id="character-skills-section">
  <summary>💫 角色技能 <span class="arrow-toggle">▼</span></summary>
  <div class="section-content" id="skills-list">
    <details class="sub-section" id="character-passive-skills-section" open>
    <summary>📌 被动技能 <span class="arrow-toggle">▼</span></summary>
    <div class="sub-section-content" id="passive-skills-list-container"></div>
    <p id="no-passive-skills-msg" class="hidden">（尚未拥有任何被动技能）</p>
    </details>
    <hr class="thin-divider" />
    <details class="sub-section" id="character-active-skills-section" open>
    <summary>🌀 主动技能 <span class="arrow-toggle">▼</span></summary>
    <div class="sub-section-content" id="active-skills-list-container"></div>
    <p id="no-active-skills-msg" class="hidden">（尚未习得任何主动技能）</p>
    </details>
  </div>
  </details>

   <!-- 角色背包 -->
   <details class="section" id="character-inventory-section">
    <summary>🎒 角色背包 <span class="summary-details"><span id="inventory-summary-details"></span><span id="inventory-item-count"></span></span><span class="arrow-toggle">▼</span></summary>
    <div class="section-content">
     <div class="inventory-category">
      <p>
    	<span class="property-name">💰 货币:</span>&nbsp;&nbsp;
    	<span class="currency-item">💠<span id="currency-platinum" class="value-main">0</span></span>&nbsp;&nbsp;
    	<span class="currency-item">🟡<span id="currency-gold" class="value-main">0</span></span>&nbsp;&nbsp;
    	<span class="currency-item">⚪<span id="currency-silver" class="value-main">0</span></span>&nbsp;&nbsp;
    	<span class="currency-item">🟤<span id="currency-copper" class="value-main">0</span></span>
      </p>
     </div>
     <hr class="thin-divider" />
     <div class="inventory-category">
      <p class="property-name">📦 物品列表:</p>
      <!-- Container for all sorted items -->
      <div id="inventory-all-items-container"></div>
      <p id="no-inventory-items-msg" class="hidden">（背包空空如也）</p>
     </div>
    </div>
   </details>

   <!-- 命运红线 -->
   <details class="section" id="destiny-section">
    <summary>💞 命运红线 <span class="summary-details" id="destiny-summary-details"></span><span class="arrow-toggle">▼</span></summary>
    <div class="section-content">
     <button id="lilith-shop-btn" class="action-button">命运抽卡(5连/500点)</button>
     <p><span class="property-name">💖 命运点数 FP:</span> <span id="destiny-fp" class="value-main">0</span></p>
     <div id="destiny-targets-container"></div>
     <p id="no-destiny-targets-msg" class="hidden">（尚未与任何人缔结深刻的命运联系）</p>
    </div>
   </details>

   <!-- 每日新闻 -->
   <details class="section" id="news-section">
    <summary>🌍 每日新闻<span class="arrow-toggle">▼</span></summary>
    <div class="section-content">
     <button id="update-news-btn" class="action-button">更新每日新闻</button>
     <details class="sub-section" id="news-gold-lion-section" open>
      <summary>
       <span class="news-headline news-gold-lion">🌍 阿斯塔利亚快讯</span><span class="arrow-toggle">▼</span>
      </summary>
      <div class="sub-section-content">
       <p id="news-gold-lion-text">（暂无最新快讯）</p>
      </div>
     </details>
     <details class="sub-section" id="news-tavern-section" open>
      <summary>
       <span class="news-headline news-tavern">🍻 酒馆留言板</span><span class="arrow-toggle">▼</span>
      </summary>
      <div class="sub-section-content">
       <p id="news-tavern-text">（留言板上空空如也）</p>
      </div>
     </details>
     <details class="sub-section" id="news-tea-party-section" open>
      <summary>
       <span class="news-headline news-tea-party">☕ 红线助手的午后茶会</span><span class="arrow-toggle">▼</span>
      </summary>
      <div class="sub-section-content">
       <p id="news-tea-party-text">（茶会上没什么新八卦）</p>
      </div>
     </details>
    </div>
   </details>
  </div>

  <script>
   // ====================================================================================
   //
   //                 【脚本主逻辑】
   //
   // ====================================================================================

   // --- 辅助工具函数 ---

   function getQualityClass(quality) {
    const qualityMap = {
     '神话': 'quality-mythic',
     '传说': 'quality-legendary',
     '史诗': 'quality-epic',
     '稀有': 'quality-rare',
     '优良': 'quality-uncommon',
     '普通': 'quality-common'
    };
    return qualityMap[quality] || 'quality-common';
   }

   function SafeGetValue(obj, path, defaultValue = '') {
    const keys = Array.isArray(path) ? path : path.split('.');
    let current = obj;
    for (let i = 0; i < keys.length; i++) {
     if (current === undefined || current === null || typeof current !== 'object' || !current.hasOwnProperty(keys[i])) {
      return defaultValue;
     }
     current = current[keys[i]];
    }
    if (current === undefined || current === null) return defaultValue;
    if (typeof defaultValue === 'object' && defaultValue !== null && typeof current === 'object') return current;
    if (Array.isArray(current)) {
     if (current.length > 0) {
      const actualValue = current[0];
      return typeof actualValue === 'boolean' ? actualValue : String(actualValue).trim();
     } else {
      return typeof defaultValue === 'string' ? String(defaultValue).trim() : defaultValue;
     }
    }
    if (typeof current === 'boolean') return current;
    return String(current).trim();
   }

   function updateProgressBar(barId, currentValue, maxValue, color = '#785A4E') {
    const progressBar = document.getElementById(barId);
    if (progressBar) {
     const current = parseFloat(currentValue) || 0;
     const max = parseFloat(maxValue) || 1; // 防止除以0
     const percentage = Math.max(0, Math.min(100, (current / max) * 100));
     progressBar.style.width = `${percentage}%`;
     progressBar.style.backgroundColor = color;
    }
   }

   function setElementText(id, value, emptyValue = '') {
    const el = document.getElementById(id);
    if (el) {
     el.innerText = value === null || value === undefined || String(value).trim() === '' ? emptyValue : String(value).trim();
    }
   }

   function setElementHTML(id, value, emptyValue = '') {
    const el = document.getElementById(id);
    if (el) {
     const finalValue = value === null || value === undefined || String(value).trim() === '' ? emptyValue : String(value).trim();
     el.innerHTML = finalValue.replace(/\n/g, '<br />');
    }
   }

   function toggleElementVisibility(elementId, show) {
    const element = document.getElementById(elementId);
    if (element) {
     element.classList.toggle('hidden', !show);
    }
   }

   function setupCollapsibles() {
    document.querySelectorAll('details > summary').forEach(summary => {
     const arrow = summary.querySelector('.arrow-toggle');
     if (arrow && !summary.dataset.listenerAttached) {
      summary.dataset.listenerAttached = 'true';
      summary.addEventListener('click', function () {
       const detailsElement = this.parentElement;
       setTimeout(() => {
        const nowOpen = detailsElement.hasAttribute('open');
        arrow.style.transform = nowOpen ? 'rotate(90deg)' : '';
       }, 0);
      });
      if (summary.parentElement.hasAttribute('open')) {
       arrow.style.transform = 'rotate(90deg)';
      } else {
       arrow.style.transform = '';
      }
     }
    });
   }

   // --- 数据更新函数 ---

   function updateWorldState(data) {
    setElementText('world-time', SafeGetValue(data, '世界.时间', '未知时间'));
    setElementText('world-location', SafeGetValue(data, '世界.地点', '未知地点'));
   }

   function updateAscensionLadder(data) {
    const ascensionData = SafeGetValue(data, '登神长阶', {});
    const userLevel = parseInt(SafeGetValue(data, '角色.状态.等级', '1'), 10);
    const mainSection = document.getElementById('ascension-section');
    let summaryText;
    const createStepItemHTML = (name, desc) => `<div class="step-item"><span class="item-name">❖ ${name}:</span><span class="item-desc">${desc}</span></div>`;

    const setupStep = (levelReq, detailsId) => {
      const detailsEl = document.getElementById(detailsId);
      if (userLevel < levelReq) {
        detailsEl.classList.add('locked');
        detailsEl.open = false;
      } else {
        detailsEl.classList.remove('locked');
      }
    };

    if (userLevel < 60) {
      summaryText = '长阶未开启';
      mainSection.classList.add('locked');
    } else {
      summaryText = '长阶已启';
      mainSection.classList.remove('locked');
    }

    setupStep(60, 'ascension-elements-details');
    setupStep(80, 'ascension-authority-details');
    setupStep(90, 'ascension-laws-details');
    setupStep(100, 'ascension-divinity-details');

    const elementsList = document.getElementById('ascension-elements-list');
    let elementsHtml = '';
    let hasElements = false;
    if (userLevel >= 60) {
      const elementsArray = SafeGetValue(ascensionData, '要素', []);
      const elementsObj = Array.isArray(elementsArray) && elementsArray.length > 0 ? elementsArray[0] : {};
      const elementKeys = Object.keys(elementsObj).filter(key => key !== '$meta' && SafeGetValue(elementsObj[key], '名称'));
      if (elementKeys.length > 0) {
        hasElements = true;
        summaryText = '当前阶段: 要素';
        elementKeys.forEach(key => elementsHtml += createStepItemHTML(SafeGetValue(elementsObj[key], '名称'), SafeGetValue(elementsObj[key], '描述')));
      }
    }
    elementsList.innerHTML = elementsHtml;
    toggleElementVisibility('no-elements-msg', !hasElements);

    const authorityList = document.getElementById('ascension-authority-list');
    let authorityHtml = '';
    let hasAuthority = false;
    if (userLevel >= 80) {
      const authorityArray = SafeGetValue(ascensionData, '权能', []);
      const authorityObj = Array.isArray(authorityArray) && authorityArray.length > 0 ? authorityArray[0] : {};
      const authorityKeys = Object.keys(authorityObj).filter(key => key !== '$meta' && SafeGetValue(authorityObj[key], '名称'));
      if (authorityKeys.length > 0) {
        hasAuthority = true;
        summaryText = '当前阶段: 权能';
        authorityKeys.forEach(key => authorityHtml += createStepItemHTML(SafeGetValue(authorityObj[key], '名称'), SafeGetValue(authorityObj[key], '描述')));
      }
    }
    authorityList.innerHTML = authorityHtml;
    toggleElementVisibility('no-authority-msg', !hasAuthority);

    const lawsList = document.getElementById('ascension-laws-list');
    let lawsHtml = '';
    let hasLaws = false;
    if (userLevel >= 90) {
      const lawsArray = SafeGetValue(ascensionData, '法则', []);
      const lawsObj = Array.isArray(lawsArray) && lawsArray.length > 0 ? lawsArray[0] : {};
      const lawKeys = Object.keys(lawsObj).filter(key => key !== '$meta' && SafeGetValue(lawsObj[key], '名称'));
      if (lawKeys.length > 0) {
        hasLaws = true;
        summaryText = '当前阶段: 法则';
        lawKeys.forEach(key => lawsHtml += createStepItemHTML(SafeGetValue(lawsObj[key], '名称'), SafeGetValue(lawsObj[key], '描述')));
      }
    }
    lawsList.innerHTML = lawsHtml;
    toggleElementVisibility('no-laws-msg', !hasLaws);

    let divinityName = '', kingdomName = '';
    if (userLevel >= 100) {
      divinityName = SafeGetValue(ascensionData, '神位', '');
      kingdomName = SafeGetValue(ascensionData, '神国.名称', '');
      if (divinityName) {
        summaryText = `已登神: ${divinityName}`;
      }
    }
    setElementText('ascension-divinity-name', divinityName);
    toggleElementVisibility('divinity-empty-slot', !divinityName);
    setElementText('ascension-kingdom-name', kingdomName);
    toggleElementVisibility('kingdom-empty-slot', !kingdomName);

    setElementText('ascension-summary-details', summaryText);
   }

   function updateTasks(data) {
    const container = document.getElementById('tasks-list-container');
    const summaryDetails = document.getElementById('tasks-summary-details');
    const taskArray = SafeGetValue(data, '任务列表', []);
    const taskList = Array.isArray(taskArray) && taskArray.length > 0 ? taskArray[0] : null;
    let tasksHtml = '';
    let taskCount = 0;

    if (taskList && typeof taskList === 'object') {
      const taskKeys = Object.keys(taskList).filter(key => key !== '$meta' && SafeGetValue(taskList[key], '标题'));
      taskCount = taskKeys.length;

      if (taskCount > 0) {
        for (const taskKey of taskKeys) {
          const title = SafeGetValue(taskList[taskKey], '标题');
          const intro = SafeGetValue(taskList[taskKey], '简介');
          const target = SafeGetValue(taskList[taskKey], '目标');
          const reward = SafeGetValue(taskList[taskKey], '奖励');
          tasksHtml += `<details class="task-entry"><summary>🚩 <span class="value-main">${title}</span> <span class="arrow-toggle">▼</span></summary><div class="task-content"><p>📖 简介: <span class="value-main">${intro}</span></p><p>🎯 目标: <span class="value-main">${target}</span></p><p>🏆 奖励: <span class="value-main">${reward}</span></p></div></details>`;
        }
      }
    }

    container.innerHTML = tasksHtml;
    summaryDetails.textContent = `进行中: ${taskCount}个`;
    toggleElementVisibility('no-tasks-msg', taskCount === 0);
   }

   function updateCharacterResources(data) {
    const resources = {
     hp: { current: '角色.资源.生命值', max: '角色.资源.生命值上限', bar: 'char-hp-bar', color: '#D32F2F' },
     mp: { current: '角色.资源.法力值', max: '角色.资源.法力值上限', bar: 'char-mp-bar', color: '#1976D2' },
     sp: { current: '角色.资源.体力值', max: '角色.资源.体力值上限', bar: 'char-sp-bar', color: '#388E3C' },
     exp: { current: '角色.状态.累计经验值', max: '角色.状态.升级所需经验', bar: 'char-exp-bar', color: '#FFA000' }
    };

    for (const [key, paths] of Object.entries(resources)) {
      const currentVal = SafeGetValue(data, paths.current, '0');
      const maxVal = SafeGetValue(data, paths.max, key === 'exp' ? '0' : '1');
      setElementText(`char-${key}`, currentVal);
      setElementText(`char-${key}-${key === 'exp' ? 'needed' : 'max'}`, maxVal);
      updateProgressBar(paths.bar, currentVal, maxVal, paths.color);
    }
   }

   function updateCharacterStatus(data) {
    setElementText('char-race', SafeGetValue(data, '角色.种族', '未知'));
    setElementText('char-identity', SafeGetValue(data, '角色.身份', '暂无'));
    setElementText('char-occupation', SafeGetValue(data, '角色.职业', '暂无'));
    setElementText('char-power-level', SafeGetValue(data, '角色.状态.战力层级', '第一层级/普通层级'));
    setElementText('char-level', SafeGetValue(data, '角色.状态.等级', '1'));
    setElementText('char-adventurer-rank', SafeGetValue(data, '角色.状态.冒险者等级', '未评级'));
    setElementText('char-title', SafeGetValue(data, '角色.状态.称号', '无'));
    setElementText('char-title-effect', SafeGetValue(data, '角色.状态.称号效果', '无'));

    const statusContainer = document.getElementById('char-instant-status-container');
    const statusArray = SafeGetValue(data, '角色.状态.即时状态', []);
    const statusObj = Array.isArray(statusArray) && statusArray.length > 0 ? statusArray[0] : {};
    let statusHtml = '';
    let hasStatus = false;

    if (statusObj && typeof statusObj === 'object') {
      const statusKeys = Object.keys(statusObj).filter(key => key !== '$meta' && (SafeGetValue(statusObj[key], '名称') || SafeGetValue(statusObj[key], '效果')));
      if (statusKeys.length > 0) {
        hasStatus = true;
        for (const key of statusKeys) {
          const statusData = statusObj[key];
          const name = SafeGetValue(statusData, '名称', key);
          const effect = SafeGetValue(statusData, '效果');
          const duration = SafeGetValue(statusData, '持续');
          let text = `<span class="status-name">${name}</span>`;
          if (effect) text += `: ${effect}`;
          if (duration) text += ` (${duration})`;
          statusHtml += `<p class="instant-status-item">- ${text}</p>`;
        }
      }
    }
    statusContainer.innerHTML = statusHtml;
    toggleElementVisibility('no-instant-status-msg', !hasStatus);
   }

   function updateCharacterAttributes(data) {
    const ap = parseInt(SafeGetValue(data, '角色.属性.属性点', '0'), 10);
    setElementText('char-ap', ap);

    const stats = {
      str: '角色.属性.力量', agi: '角色.属性.敏捷', con: '角色.属性.体质',
      int: '角色.属性.智力', spi: '角色.属性.精神'
    };

    for (const [key, path] of Object.entries(stats)) {
     const value = SafeGetValue(data, path, '0');
     setElementText(`char-${key}-display`, value);
    }
   }

   function updateSkills(data) {
    const rarityOrder = { '神话': 6, '传说': 5, '史诗': 4, '稀有': 3, '优良': 2, '普通': 1 };
    let passiveSkills = [];
    let activeSkills = [];

    const skillListContainer = SafeGetValue(data, '技能列表', []);
    const skillList = Array.isArray(skillListContainer) && skillListContainer.length > 0 ? skillListContainer[0] : null;
    if (skillList && typeof skillList === 'object') {
      const skillKeys = Object.keys(skillList).filter(key => key !== '$meta' && SafeGetValue(skillList[key], '名称'));

      for (const key of skillKeys) {
        const skill = skillList[key];
        const skillData = {
          name: SafeGetValue(skill, '名称'),
          quality: SafeGetValue(skill, '品质'),
          cost: SafeGetValue(skill, '消耗', ''),
          desc: SafeGetValue(skill, '描述'),
          type: SafeGetValue(skill, '类型')
        };
        if (skillData.type === '被动') {
          passiveSkills.push(skillData);
        } else if (skillData.type === '主动') {
          activeSkills.push(skillData);
        }
      }
    }

    const sortByRarity = (a, b) => (rarityOrder[b.quality] || 0) - (rarityOrder[a.quality] || 0);
    passiveSkills.sort(sortByRarity);
    activeSkills.sort(sortByRarity);

    const createPassiveSkillHtml = (skill) => {
     const qualityClass = getQualityClass(skill.quality);
     const displayNameHTML = `<span class="${qualityClass}">${skill.name}${skill.quality ? `(${skill.quality})` : ''}</span>`;
     return `<details class="skill-entry"><summary><span class="value-main">${displayNameHTML}</span> <span class="arrow-toggle">▼</span></summary><div class="skill-description">${skill.desc}</div></details>`;
    };
    const createActiveSkillHtml = (skill) => {
     const qualityClass = getQualityClass(skill.quality);
     const displayNameHTML = `<span class="${qualityClass}">${skill.name}${skill.quality ? `(${skill.quality})` : ''}</span>`;
     const titleHTML = skill.cost ? `${displayNameHTML} | ${skill.cost}` : displayNameHTML;
     return `<details class="skill-entry"><summary><span class="value-main">${titleHTML}</span> <span class="arrow-toggle">▼</span></summary><div class="skill-description">${skill.desc}</div></details>`;
    };

    const passiveHtml = passiveSkills.map(createPassiveSkillHtml).join('');
    const activeHtml = activeSkills.map(createActiveSkillHtml).join('');

    document.getElementById('passive-skills-list-container').innerHTML = passiveHtml;
    document.getElementById('active-skills-list-container').innerHTML = activeHtml;
    toggleElementVisibility('no-passive-skills-msg', passiveSkills.length === 0);
    toggleElementVisibility('no-active-skills-msg', activeSkills.length === 0);
   }

   function updateEquipment(data) {
     const equipSlots = {
       weapon: '主武器', offhand: '副武器', hands: '手部防具', head: '头部防具',
       'body': '身体防具', feet: '脚部防具',
       acc1: '饰品1', acc2: '饰品2'
     };
     const equipData = SafeGetValue(data, '财产.装备', {});

     for (const [slot, key] of Object.entries(equipSlots)) {
       const name = SafeGetValue(equipData, `${key}.名称`, '无装备');
       const quality = SafeGetValue(equipData, `${key}.品质`);
       const desc = SafeGetValue(equipData, `${key}.描述`);

       let displayNameHTML;
       if (name !== '无装备') {
           const qualityClass = getQualityClass(quality);
           displayNameHTML = `<span class="${qualityClass}">${name}${quality ? `(${quality})` : ''}</span>`;
       } else {
           displayNameHTML = '无装备';
       }

       const nameElement = document.getElementById(`equip-${slot}-name`);
       if (nameElement) {
           nameElement.innerHTML = displayNameHTML;
       }

       const hasDesc = desc && name !== '无装备';
       if (hasDesc) {
         setElementText(`equip-${slot}-desc`, desc);
       }
       toggleElementVisibility(`equip-${slot}-desc-p`, hasDesc);
     }
   }

   function updateInventory(data) {
    // 货币
    const currencyData = SafeGetValue(data, '财产.货币', {});
    const platinum = SafeGetValue(currencyData, '白金币', '0');
    const gold = SafeGetValue(currencyData, '金币', '0');
    const silver = SafeGetValue(currencyData, '银币', '0');
    const copper = SafeGetValue(currencyData, '铜币', '0');
    const currencySummaryText = `白金币: ${platinum} | 金币: ${gold} | 银币: ${silver} | 铜币: ${copper}`;
    setElementText('inventory-summary-details', currencySummaryText); // 更新货币摘要
    setElementText('currency-platinum', platinum);
    setElementText('currency-gold', gold);
    setElementText('currency-silver', silver);
    setElementText('currency-copper', copper);

    // 物品
    const rarityOrder = { '神话': 6, '传说': 5, '史诗': 4, '稀有': 3, '优良': 2, '普通': 1 };
    const typeOrder = { '武器防具': 4, '其它物品': 3, '消耗品': 2, '材料': 1 };
    let allItems = [];
    const inventoryArray = SafeGetValue(data, '财产.背包', []);
    const inventoryObject = Array.isArray(inventoryArray) && inventoryArray.length > 0 ? inventoryArray[0] : null;
    let itemCount = 0; // 初始化物品种类计数器
    if (inventoryObject && typeof inventoryObject === 'object') {
     const itemKeys = Object.keys(inventoryObject).filter(key => key !== '$meta' && SafeGetValue(inventoryObject[key], '道具名'));
     itemCount = itemKeys.length; // 获取物品种类数量
     for (const key of itemKeys) {
      const item = inventoryObject[key];
      const itemData = {
       name: SafeGetValue(item, '道具名'),
       quality: SafeGetValue(item, '品质'),
       qty: SafeGetValue(item, '数量', '1'),
       type: SafeGetValue(item, '类型', '其它物品'),
       desc: SafeGetValue(item, '描述', '无')
      };
      if (!typeOrder.hasOwnProperty(itemData.type)) {
       itemData.type = '其它物品';
      }
      allItems.push(itemData);
     }
    }
    
    const itemCountSummaryText = ` | 物品: ${itemCount}种`;
    setElementText('inventory-item-count', itemCountSummaryText);
    allItems.sort((a, b) => {
     const typeValueA = typeOrder[a.type] || 0;
     const typeValueB = typeOrder[b.type] || 0;
     if (typeValueA !== typeValueB) {
      return typeValueB - typeValueA;
     }
     const rarityValueA = rarityOrder[a.quality] || 0;
     const rarityValueB = rarityOrder[b.quality] || 0;
     return rarityValueB - rarityValueA;
    });
    const createItemHtml = (item) => {
     const qualityClass = getQualityClass(item.quality);
     const displayNameHTML = `<span class="${qualityClass}">${item.name}${item.quality ? `(${item.quality})` : ''}</span>`;
     return `<details class="inventory-item-entry"><summary><span class="value-main">${displayNameHTML} | ${item.qty}</span><span class="arrow-toggle">▼</span></summary><div class="inventory-item-details"><p><span class="property-name">类型:</span> ${item.type}</p><p><span class="property-name">描述:</span> ${item.desc}</p></div></details>`;
    };
    
    const allItemsHtml = allItems.map(createItemHtml).join('');
    document.getElementById('inventory-all-items-container').innerHTML = allItemsHtml;
    toggleElementVisibility('no-inventory-items-msg', allItems.length === 0);
   }

   function updateDestinySystem(data) {
    const destinyData = SafeGetValue(data, '命运系统', {});
    const fp = SafeGetValue(destinyData, '命运点数', '0');
    setElementText('destiny-fp', fp);

    const container = document.getElementById('destiny-targets-container');
    const summaryDetails = document.getElementById('destiny-summary-details');
    const destinyArray = SafeGetValue(destinyData, '红线对象', []);
    const destinyObject = Array.isArray(destinyArray) && destinyArray.length > 0 ? destinyArray[0] : null;
    let destinyHtml = '';
    const affectionBarsToUpdate = [];
    let characterCount = 0;

    if (destinyObject && typeof destinyObject === 'object') {
      const characterKeys = Object.keys(destinyObject).filter(key => key !== '$meta' && SafeGetValue(destinyObject[key], '名称'));
      characterCount = characterKeys.length;

      if (characterCount > 0) {
        for (const key of characterKeys) {
          const char = destinyObject[key];
          const barId = `destiny-target-${key.replace(/\s+/g, '-')}-affection-bar`;
          destinyHtml += createDestinyTargetHTML(char, key, barId);
          const affectionRaw = SafeGetValue(char, '好感度', '0/1000');
          const [current, max] = String(affectionRaw).split(' ')[0].split('/').map(Number);
          affectionBarsToUpdate.push({ barId, current, max: max || 1000 });
        }
      }
    }

    container.innerHTML = destinyHtml;
    summaryDetails.textContent = `FP: ${fp} | 红线: ${characterCount}人`;
    toggleElementVisibility('no-destiny-targets-msg', characterCount === 0);
    affectionBarsToUpdate.forEach(bar => updateProgressBar(bar.barId, bar.current, bar.max, '#EC407A'));
   }

   function createDestinyTargetHTML(character, charKey, barId) {
    const name = SafeGetValue(character, '名称');
    const powerLevel = SafeGetValue(character, '战力层级');
    const level = SafeGetValue(character, '等级');
    const race = SafeGetValue(character, '种族');
    const identity = SafeGetValue(character, '身份');
    const occupation = SafeGetValue(character, '职业');
    const personality = SafeGetValue(character, '性格');
    const favorites = SafeGetValue(character, '喜爱');
    const appearance = SafeGetValue(character, '外貌特质');
    const adornments = SafeGetValue(character, '衣物装饰');
    const equipment = SafeGetValue(character, '角色装备');
    const ascension = SafeGetValue(character, '登神长阶');
    const isTied = SafeGetValue(character, '是否缔结红线', '否');
    const affectionText = String(SafeGetValue(character, '好感度', '0/1000')).split(' ')[0];
    const evalText = SafeGetValue(character, '评价');
    const backstory = SafeGetValue(character, '背景故事');
    const bondSkillText = SafeGetValue(character, '羁绊技能');

    const powerLevelHTML = `<p><span class="property-name">⚜️ 战力层级:</span> <span class="value-main">${powerLevel || '未知'}</span></p>`;
    const levelHTML = `<p><span class="property-name">✨ 等级:</span> <span class="value-main">${level || '未知'}</span></p>`;
    const raceHTML = `<p><span class="property-name">🧬 种族:</span> <span class="value-main">${race || '未知'}</span></p>`;
    const identityHTML = `<p><span class="property-name">👑 身份:</span> <span class="value-main">${identity || '未知'}</span></p>`;
    const occupationHTML = `<p><span class="property-name">⚖️ 职业:</span> <span class="value-main">${occupation || '未知'}</span></p>`;
    const personalityHTML = `<p><span class="property-name">🎭 性格:</span> <span class="value-main">${personality || '未知'}</span></p>`;
    const favoritesHTML = `<p><span class="property-name">💖 喜爱:</span> <span class="value-main">${favorites || '未知'}</span></p>`;
    const appearanceHTML = `<p><span class="property-name">🌸 外貌特质:</span> <span class="value-main">${appearance || '未知'}</span></p>`;
    const adornmentsHTML = `<p><span class="property-name">👗 衣物装饰:</span> <span class="value-main">${adornments || '未知'}</span></p>`;
    const equipmentHTML = `<p><span class="property-name">⚔️ 角色装备:</span> <span class="value-main">${equipment || '未知'}</span></p>`;
    const ascensionHTML = `<p><span class="property-name">♾️登神长阶:</span> <span class="value-main">${ascension || '未开启'}</span></p>`;
    const backstoryHTML = `<p><span class="property-name">📜背景故事:</span> <span class="value-main">${backstory || '未知'}</span></p>`;

    const detailsDividerHTML = '<hr class="thin-divider">';

    let bondSkillHTML = '';
    if (isTied === '是') {
      if (bondSkillText && bondSkillText.trim() !== '') {
        const formattedBondSkills = bondSkillText.split('\n').map(line => line.trim()).filter(line => line !== '').join('<br>');
        bondSkillHTML = `<p class="value-main">${formattedBondSkills}</p>`;
      } else {
        bondSkillHTML = '<p class="value-main">（尚未觉醒）</p>';
      }
    } else {
      bondSkillHTML = '<p class="value-main">（无羁绊技能）</p>';
    }

    return `
     <details class="destiny-target" id="destiny-target-${charKey.replace(/\s+/g, '-')}-details">
      <summary><span class="value-main">${name}</span> <span class="arrow-toggle">▼</span></summary>
      <div class="destiny-target-content">
       ${powerLevelHTML}
       ${levelHTML}
       ${raceHTML}
       ${identityHTML}
       ${occupationHTML}
       ${personalityHTML}
       ${favoritesHTML}
       ${appearanceHTML}
       ${adornmentsHTML}
       ${equipmentHTML}
       ${ascensionHTML}

       ${detailsDividerHTML}
       <p><span class="property-name">是否缔结红线:</span> <span class="value-main">${isTied}</span></p>
       <p><span class="property-name">❤️ 好感度:</span> <span class="value-main">${affectionText}</span></p>
       <div class="progress-bar-container"><div id="${barId}" class="progress-bar-value"></div></div>
       <p><span class="property-name">💭 评价:</span> <span class="value-main">${evalText || '（暂无评价）'}</span></p>
       ${backstoryHTML}
       <hr class="thin-divider">
       <details class="sub-section bonds-skill-section">
        <summary>💞 羁绊技能 <span class="arrow-toggle">▼</span></summary>
        <div class="sub-section-content">${bondSkillHTML}</div>
       </details>
      </div>
     </details>`;
   }

   function updateNews(data) {
    const newsData = SafeGetValue(data, '每日新闻', {});
    const newsFields = {
     'news-gold-lion-text': { key: '阿斯塔利亚快讯', empty: '（暂无最新快讯）' },
     'news-tavern-text': { key: '酒馆留言板', empty: '（留言板上空空如也）' },
     'news-tea-party-text': { key: '红线助手的午后茶会', empty: '（茶会上没什么新八卦）' }
    };
    for (const [elementId, info] of Object.entries(newsFields)) {
     let rawValue = SafeGetValue(newsData, info.key, '');
     let formattedValue = rawValue.replace(/\|/g, '\n');
     setElementHTML(elementId, formattedValue, info.empty);
    }
   }

  function updateAllSummaryDetails(data) {
   const powerLevel = SafeGetValue(data, '角色.状态.战力层级', '第一层级/普通层级');
   const level = SafeGetValue(data, '角色.状态.等级', '1');
    const hp = SafeGetValue(data, '角色.资源.生命值', '0');
    const hpMax = SafeGetValue(data, '角色.资源.生命值上限', '0');
    const mp = SafeGetValue(data, '角色.资源.法力值', '0');
    const mpMax = SafeGetValue(data, '角色.资源.法力值上限', '0');
    const sp = SafeGetValue(data, '角色.资源.体力值', '0');
    const spMax = SafeGetValue(data, '角色.资源.体力值上限', '0');

    const statusSummaryText = `${powerLevel} | 等级: ${level} | HP: ${hp}/${hpMax} | MP: ${mp}/${mpMax} | SP: ${sp}/${spMax}`;
    setElementText('character-status-summary-details', statusSummaryText);
  }

   function setupStaticEventListeners() {
    const lilithShopButton = document.getElementById('lilith-shop-btn');
    if (lilithShopButton && !lilithShopButton.dataset.listenerAttached) {
      lilithShopButton.addEventListener('click', () => {
        const commandToSend = '/send 开始命运抽卡*5|/trigger';
        if (typeof triggerSlash === 'function') {
          triggerSlash(commandToSend);
        } else {
          console.error('triggerSlash function is not available.');
        }
      });
      lilithShopButton.dataset.listenerAttached = 'true';
    }

    const updateNewsButton = document.getElementById('update-news-btn');
    if (updateNewsButton && !updateNewsButton.dataset.listenerAttached) {
      updateNewsButton.addEventListener('click', () => {
        const commandToSend = '/send 更新"每日新闻"|/trigger';
         if (typeof triggerSlash === 'function') {
          triggerSlash(commandToSend);
         } else {
          console.error('triggerSlash function is not available.');
         }
      });
      updateNewsButton.dataset.listenerAttached = 'true';
    }
   }

   async function initDisplay() {
    try {
     const messages = await getChatMessages(getCurrentMessageId());
     if (!messages || messages.length === 0 || !messages[0].data) {
      console.error('无法加载状态数据: 消息为空或不含数据');
      return;
     }
     const characterData = messages[0].data.stat_data;
     if (!characterData) {
      console.error('无法加载状态数据: stat_data 缺失');
      return;
     }

     updateWorldState(characterData);
     updateAscensionLadder(characterData);
     updateTasks(characterData);
     updateCharacterResources(characterData);
     updateCharacterStatus(characterData);
     updateCharacterAttributes(characterData);
     updateSkills(characterData);
     updateEquipment(characterData);
     updateInventory(characterData);
     updateDestinySystem(characterData);
     updateNews(characterData);
     setupStaticEventListeners();
     updateAllSummaryDetails(characterData);
     setupCollapsibles();

    } catch (error) {
     console.error('状态栏加载出错:', error);
     document.body.innerHTML = `<p style='color:red; padding:20px; text-align:center;'>状态栏加载时出现严重错误: ${error.message}</p>`;
    }
   }

   document.addEventListener('DOMContentLoaded', initDisplay);

  </script>
 </body>
</html>
